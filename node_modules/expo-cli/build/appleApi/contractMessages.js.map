{"version":3,"file":"contractMessages.js","names":["getContractStatusAsync","context","capabilities","ITCAgreements","getCapabilitiesAsync","contractStatus","error","Log","warn","message","getContractMessagesAsync","getRequiredContractMessagesAsync","status","includes","messages","isFatal","newLine","rootUrl","formatContractMessage","convertHTMLToASCII","content","subject","filter","Boolean","join","assertContractMessagesAsync","spinner","Array","isArray","length","stop","log","chalk","yellow","bold","isDebug","JSON","stringify","addNewLineIfNone","CommandError"],"sources":["../../src/appleApi/contractMessages.ts"],"sourcesContent":["import { ITCAgreements, RequestContext } from '@expo/apple-utils';\nimport chalk from 'chalk';\nimport { Ora } from 'ora';\n\nimport CommandError from '../CommandError';\nimport Log from '../log';\nimport { convertHTMLToASCII } from './convertHTMLToASCII';\n\nasync function getContractStatusAsync(\n  context: RequestContext\n): Promise<ITCAgreements.ITCContractStatus | null> {\n  try {\n    const capabilities = await ITCAgreements.getCapabilitiesAsync(context);\n    return capabilities?.contractStatus ?? null;\n  } catch (error: any) {\n    Log.warn(`Failed to get iTunes contract status: ${error.message}`);\n    return null;\n  }\n}\n\nasync function getContractMessagesAsync(context: RequestContext) {\n  try {\n    return await ITCAgreements.getContractMessagesAsync(context);\n  } catch (error: any) {\n    Log.warn(`Failed to get iTunes contract messages: ${error.message}`);\n    return null;\n  }\n}\n\nasync function getRequiredContractMessagesAsync(\n  context: RequestContext\n): Promise<{ messages: ITCAgreements.ITCContractMessage[]; isFatal: boolean }> {\n  // This emulates the check that's performed on the ASC website's \"apps\"\n  // page before presenting the (+) create app button.\n  const status = await getContractStatusAsync(context);\n\n  if (status) {\n    if (['FREE_APP_AGREEMENT_ACTIVE', 'PAID_APP_AGREEMENT_ACTIVE'].includes(status)) {\n      // The user can freely create an app, no contracts need to be accepted.\n      // No need to check for messages because afaict no vital messages will be present.\n      return { messages: [], isFatal: false };\n    } else if (\n      ['FREE_APP_AGREEMENT_OUTDATED', 'PAID_APP_AGREEMENT_OUTDATED', 'EXPIRED_MEMBERSHIP'].includes(\n        status\n      )\n    ) {\n      // The user cannot create an app until they've reviewed, and agreed to the updated agreements\n      // or renewed their membership on ASC.\n      // Get the exact messages from ASC to show the user a useful message.\n      return { messages: (await getContractMessagesAsync(context)) ?? [], isFatal: true };\n    }\n  }\n  // The contract messages aren't documented so if a new one is present we cannot be sure if it's fatal or not.\n  // This will check for messages, if none exist, then the process will continue.\n  // Otherwise messages will be present and the process will stop.\n  // There is a small chance that this could result in a false positive if the messages are extraneous, so we'll also\n  // prompt the user to open an issue so we can address the new contract state if it ever appears.\n  // TODO: Maybe a silent analytic would be better\n  Log.error(\n    `\\nUnexpected Apple developer contract status \"${status}\". Please open an issue on https://github.com/expo/eas-cli`\n  );\n  Log.newLine();\n  return { messages: (await getContractMessagesAsync(context)) ?? [], isFatal: false };\n}\n\nconst rootUrl = 'https://appstoreconnect.apple.com';\n\nexport function formatContractMessage(message: ITCAgreements.ITCContractMessage): string {\n  return convertHTMLToASCII({\n    content:\n      '\\u203A ' +\n      [message.subject && `<b>${message.subject}</b>`, message.message]\n        .filter(Boolean)\n        .join('<br />'),\n    rootUrl,\n  });\n}\n\nexport async function assertContractMessagesAsync(context: RequestContext, spinner?: Ora) {\n  const { messages, isFatal } = await getRequiredContractMessagesAsync(context);\n\n  if (Array.isArray(messages) && messages.length) {\n    if (spinner) {\n      spinner.stop();\n    }\n    Log.newLine();\n    Log.log(chalk.yellow.bold('Messages from App Store Connect:'));\n    Log.newLine();\n    for (const message of messages) {\n      if (Log.isDebug) {\n        Log.log(JSON.stringify(message, null, 2));\n        Log.newLine();\n      }\n      Log.addNewLineIfNone();\n      Log.log(formatContractMessage(message));\n    }\n    Log.addNewLineIfNone();\n    // Only throw an error if we know that the status is fatal, otherwise attempt to finish the process.\n    if (isFatal) {\n      throw new CommandError('App Store Connect has agreement updates that must be resolved');\n    }\n  }\n}\n"],"mappings":"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"}