{"version":3,"file":"startBuildAsync.js","names":["validateOptions","options","schema","Joi","object","keys","current","boolean","mode","string","platform","any","valid","expIds","array","type","releaseChannel","regex","bundleIdentifier","publicUrl","sdkVersion","strict","error","validate","XDLError","toString","getConfigAsync","projectRoot","exp","pkg","getConfig","configName","configFilename","configPrefix","ThirdParty","getManifest","getExpAsync","version","name","slug","toLowerCase","startBuildAsync","user","UserManager","ensureLoggedInAsync","validateManifest","Analytics","logEvent","developerTool","Config","api","ApiV2","clientForUser","putAsync","manifest","ios","android","package"],"sources":["../../../src/commands/build/startBuildAsync.ts"],"sourcesContent":["import { configFilename, getConfig } from '@expo/config';\nimport Joi from 'joi';\nimport slug from 'slugify';\nimport { Analytics, ApiV2, Config, ThirdParty, UserManager, XDLError } from 'xdl';\n\nexport type BuildCreatedResult = {\n  id: string;\n  ids: string[];\n  priority: 'normal' | 'high';\n  canPurchasePriorityBuilds: boolean;\n  numberOfRemainingPriorityBuilds: number;\n  hasUnlimitedPriorityBuilds: boolean;\n};\n\nexport type GetExpConfigOptions = {\n  current?: boolean;\n  mode?: string;\n  platform?: 'android' | 'ios' | 'all';\n  expIds?: string[];\n  type?: string;\n  releaseChannel?: string;\n  bundleIdentifier?: string;\n  publicUrl?: string;\n  sdkVersion?: string;\n};\n\nexport function validateOptions(options: any) {\n  const schema = Joi.object().keys({\n    current: Joi.boolean(),\n    mode: Joi.string(),\n    platform: Joi.any().valid('ios', 'android', 'all'),\n    expIds: Joi.array(),\n    type: Joi.any().valid('archive', 'simulator', 'client', 'app-bundle', 'apk'),\n    releaseChannel: Joi.string().regex(/[a-z\\d][a-z\\d._-]*/),\n    bundleIdentifier: Joi.string().regex(/^[a-zA-Z0-9-.]+$/),\n    publicUrl: Joi.string(),\n    sdkVersion: Joi.string().strict(),\n  });\n\n  const { error } = schema.validate(options);\n  if (error) {\n    throw new XDLError('INVALID_OPTIONS', error.toString());\n  }\n}\n\nasync function getConfigAsync(\n  projectRoot: string,\n  options: Pick<GetExpConfigOptions, 'publicUrl' | 'platform'> = {}\n) {\n  if (!options.publicUrl) {\n    // get the manifest from the project directory\n    const { exp, pkg } = getConfig(projectRoot);\n    const configName = configFilename(projectRoot);\n    return {\n      exp,\n      pkg,\n      configName: configFilename(projectRoot),\n      configPrefix: configName === 'app.json' ? 'expo.' : '',\n    };\n  } else {\n    // get the externally hosted manifest\n    return {\n      exp: await ThirdParty.getManifest(options.publicUrl, options),\n      configName: options.publicUrl,\n      configPrefix: '',\n      pkg: {},\n    };\n  }\n}\n\nexport async function getExpAsync(\n  projectRoot: string,\n  options: Pick<GetExpConfigOptions, 'publicUrl' | 'mode' | 'platform'>\n) {\n  const { exp, pkg, configName, configPrefix } = await getConfigAsync(projectRoot, options);\n\n  if (!exp || !pkg) {\n    throw new XDLError(\n      'NO_PACKAGE_JSON',\n      `Couldn't read ${configName} file in project at ${projectRoot}`\n    );\n  }\n\n  // Support version and name being specified in package.json for legacy\n  // support pre: exp.json\n  if (!exp.version && 'version' in pkg && pkg.version) {\n    exp.version = pkg.version;\n  }\n  if (!exp.name && 'name' in pkg && typeof pkg.name === 'string') {\n    exp.name = pkg.name;\n  }\n  if (!exp.slug && typeof exp.name === 'string') {\n    exp.slug = slug(exp.name.toLowerCase());\n  }\n  return { exp, configName, configPrefix };\n}\n\nexport async function startBuildAsync(\n  projectRoot: string,\n  options: GetExpConfigOptions = {}\n): Promise<BuildCreatedResult> {\n  const user = await UserManager.ensureLoggedInAsync();\n\n  validateOptions(options);\n  const { exp, configName, configPrefix } = await getExpAsync(projectRoot, options);\n  validateManifest(options, exp, configName, configPrefix);\n\n  Analytics.logEvent('Build Shell App', {\n    projectRoot,\n    developerTool: Config.developerTool,\n    platform: options.platform,\n  });\n\n  const api = ApiV2.clientForUser(user);\n  return await api.putAsync('build/start', { manifest: exp, options });\n}\n\nfunction validateManifest(options: any, exp: any, configName: string, configPrefix: string) {\n  if (options.platform === 'ios' || options.platform === 'all') {\n    if (!exp.ios || !exp.ios.bundleIdentifier) {\n      throw new XDLError(\n        'INVALID_MANIFEST',\n        `Must specify a bundle identifier in order to build this experience for iOS. ` +\n          `Please specify one in ${configName} at \"${configPrefix}ios.bundleIdentifier\"`\n      );\n    }\n  }\n\n  if (options.platform === 'android' || options.platform === 'all') {\n    if (!exp.android || !exp.android.package) {\n      throw new XDLError(\n        'INVALID_MANIFEST',\n        `Must specify a java package in order to build this experience for Android. ` +\n          `Please specify one in ${configName} at \"${configPrefix}android.package\"`\n      );\n    }\n  }\n}\n"],"mappings":"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"}