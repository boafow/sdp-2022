{"version":3,"file":"installAsync.js","names":["resolveExpoProjectRootAsync","info","findProjectRootAsync","process","cwd","projectRoot","error","code","Log","addNewLineIfNone","message","newLine","log","chalk","cyan","bold","SilentError","actionAsync","packages","options","warnAboutLocalCLI","localCmd","packageManager","PackageManager","createForProject","npm","yarn","exp","pkg","getConfig","skipSDKVersionRequirement","skipPlugins","dependencies","addAsync","sdkVersion","CommandError","name","toLowerCase","Versions","gteSdkVersion","resolveFrom","silent","installAsync","bundledNativeModules","getBundledNativeModulesAsync","versionsForSdk","getRemoteVersionsForSdk","nativeModulesCount","othersCount","unparsedParameterFound","parameters","forEach","packageName","startsWith","push","versionedPackages","filter","arg","includes","map","type","raw","npmPackageArg","messages","Boolean","join","addWithParametersAsync","autoAddConfigPluginsAsync","split","isPluginError","warn"],"sources":["../../src/commands/installAsync.ts"],"sourcesContent":["import { getConfig } from '@expo/config';\nimport * as PackageManager from '@expo/package-manager';\nimport chalk from 'chalk';\nimport npmPackageArg from 'npm-package-arg';\nimport resolveFrom from 'resolve-from';\nimport { Versions } from 'xdl';\n\nimport CommandError, { SilentError } from '../CommandError';\nimport Log from '../log';\nimport { getRemoteVersionsForSdk } from '../utils/getRemoteVersionsForSdk';\nimport { warnAboutLocalCLI } from '../utils/migration';\nimport { findProjectRootAsync } from './utils/ProjectUtils';\nimport { autoAddConfigPluginsAsync } from './utils/autoAddConfigPluginsAsync';\nimport { getBundledNativeModulesAsync } from './utils/bundledNativeModules';\n\nasync function resolveExpoProjectRootAsync() {\n  try {\n    const info = await findProjectRootAsync(process.cwd());\n    return info.projectRoot;\n  } catch (error: any) {\n    if (error.code !== 'NO_PROJECT') {\n      // An unknown error occurred.\n      throw error;\n    }\n    // This happens when an app.config exists but a package.json is not present.\n    Log.addNewLineIfNone();\n    Log.error(error.message);\n    Log.newLine();\n    Log.log(chalk.cyan(`You can create a new project with ${chalk.bold(`expo init`)}`));\n    Log.newLine();\n    throw new SilentError(error);\n  }\n}\n\nexport async function actionAsync(\n  packages: string[],\n  options: PackageManager.CreateForProjectOptions\n) {\n  const projectRoot = await resolveExpoProjectRootAsync();\n  warnAboutLocalCLI(projectRoot, { localCmd: 'install' });\n\n  const packageManager = PackageManager.createForProject(projectRoot, {\n    npm: options.npm,\n    yarn: options.yarn,\n    log: Log.log,\n  });\n\n  let { exp, pkg } = getConfig(projectRoot, {\n    skipSDKVersionRequirement: true,\n    // Sometimes users will add a plugin to the config before installing the library,\n    // this wouldn't work unless we dangerously disable plugin serialization.\n    skipPlugins: true,\n  });\n\n  // If using `expo install` in a project without the expo package even listed\n  // in package.json, just fall through to npm/yarn.\n  //\n  if (!pkg.dependencies?.['expo']) {\n    return await packageManager.addAsync(...packages);\n  }\n\n  if (!exp.sdkVersion) {\n    Log.addNewLineIfNone();\n    throw new CommandError(\n      `The ${chalk.bold(`expo`)} package was found in your ${chalk.bold(\n        `package.json`\n      )} but we couldn't resolve the Expo SDK version. Run ${chalk.bold(\n        `${packageManager.name.toLowerCase()} install`\n      )} and then try this command again.\\n`\n    );\n  }\n\n  if (!Versions.gteSdkVersion(exp, '33.0.0')) {\n    const message = `${chalk.bold(\n      `expo install`\n    )} is only available for Expo SDK version 33 or higher.`;\n    Log.addNewLineIfNone();\n    Log.error(message);\n    Log.newLine();\n    Log.log(chalk.cyan(`Current version: ${chalk.bold(exp.sdkVersion)}`));\n    Log.newLine();\n    throw new SilentError(message);\n  }\n\n  // This shouldn't be invoked because `findProjectRootAsync` will throw if node_modules are missing.\n  // Every React project should have react installed...\n  if (!resolveFrom.silent(projectRoot, 'react')) {\n    Log.addNewLineIfNone();\n    Log.log(chalk.cyan(`node_modules not found, running ${packageManager.name} install command.`));\n    Log.newLine();\n    await packageManager.installAsync();\n  }\n\n  const bundledNativeModules = await getBundledNativeModulesAsync(projectRoot, exp.sdkVersion);\n  const versionsForSdk = await getRemoteVersionsForSdk(exp.sdkVersion);\n\n  let nativeModulesCount = 0;\n  let othersCount = 0;\n  let unparsedParameterFound = false;\n  const parameters: string[] = [];\n\n  // Detect unparsed parameters that are passed in\n  // Assume anything after the first one to be a parameter (to support cases like `-- --loglevel verbose`)\n  packages.forEach(packageName => {\n    if (packageName.startsWith('-')) {\n      unparsedParameterFound = true;\n    }\n\n    if (unparsedParameterFound) {\n      parameters.push(packageName);\n    }\n  });\n\n  const versionedPackages = packages\n    .filter(arg => !parameters.includes(arg))\n    .map(arg => {\n      const { name, type, raw } = npmPackageArg(arg);\n\n      if (['tag', 'version', 'range'].includes(type) && name && bundledNativeModules[name]) {\n        // Unimodule packages from npm registry are modified to use the bundled version.\n        nativeModulesCount++;\n        return `${name}@${bundledNativeModules[name]}`;\n      } else if (name && versionsForSdk[name]) {\n        // Some packages have the recommended version listed in https://exp.host/--/api/v2/versions.\n        othersCount++;\n        return `${name}@${versionsForSdk[name]}`;\n      } else {\n        // Other packages are passed through unmodified.\n        othersCount++;\n        return raw;\n      }\n    });\n\n  const messages = [\n    nativeModulesCount > 0 &&\n      `${nativeModulesCount} SDK ${exp.sdkVersion} compatible native ${\n        nativeModulesCount === 1 ? 'module' : 'modules'\n      }`,\n    othersCount > 0 && `${othersCount} other ${othersCount === 1 ? 'package' : 'packages'}`,\n  ].filter(Boolean);\n  Log.log(`Installing ${messages.join(' and ')} using ${packageManager.name}.`);\n\n  await packageManager.addWithParametersAsync(versionedPackages, parameters);\n\n  try {\n    exp = getConfig(projectRoot, { skipSDKVersionRequirement: true }).exp;\n\n    // Only auto add plugins if the plugins array is defined or if the project is using SDK +42.\n    await autoAddConfigPluginsAsync(\n      projectRoot,\n      exp,\n      versionedPackages.map(pkg => pkg.split('@')[0]).filter(Boolean)\n    );\n  } catch (error: any) {\n    if (error.isPluginError) {\n      Log.warn(`Skipping config plugin check: ` + error.message);\n      return;\n    }\n    throw error;\n  }\n}\n"],"mappings":"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"}