{"version":3,"file":"getUsageAsync.js","names":["getUsageAsync","projectRoot","_getUsageAsync","e","Log","warn","_getGenericUsage","allPlatforms","publishesResult","getPublishHistoryAsync","releaseChannel","count","length","publishes","queryResult","uniquePlatforms","uniqBy","publish","platform","details","Promise","all","map","publication","detailOptions","publishId","publicationId","getPublicationDetailAsync","uniqueRevisionIds","detail","revisionId","channel","publishedTime","sdkVersion","timeDifferenceString","_getTimeDifferenceString","Date","t0","t1","minutesInMs","hourInMs","dayInMs","diffMs","Math","abs","getTime","diffDays","round","diffHours","diffMinutes"],"sources":["../../../src/commands/publish/getUsageAsync.ts"],"sourcesContent":["import uniqBy from 'lodash/uniqBy';\n\nimport Log from '../../log';\nimport {\n  getPublicationDetailAsync,\n  getPublishHistoryAsync,\n  Publication,\n} from '../utils/PublishUtils';\n\nexport async function getUsageAsync(projectRoot: string): Promise<string> {\n  try {\n    return await _getUsageAsync(projectRoot);\n  } catch (e: any) {\n    Log.warn(e);\n    // couldn't print out warning for some reason\n    return _getGenericUsage();\n  }\n}\n\nasync function _getUsageAsync(projectRoot: string): Promise<string> {\n  const allPlatforms = ['ios', 'android'];\n  const publishesResult = await getPublishHistoryAsync(projectRoot, {\n    releaseChannel: 'default', // not specifying a channel will return most recent publishes but this is not neccesarily the most recent entry in a channel (user could have set an older publish to top of the channel)\n    count: allPlatforms.length,\n  });\n  const publishes = publishesResult.queryResult as Publication[];\n\n  // If the user published normally, there would be a publish for each platform with the same revisionId\n  const uniquePlatforms = uniqBy(publishes, publish => publish.platform);\n  if (uniquePlatforms.length !== allPlatforms.length) {\n    // User probably applied some custom `publish:set` or `publish:rollback` command\n    return _getGenericUsage();\n  }\n\n  const details = await Promise.all(\n    publishes.map(async publication => {\n      const detailOptions = {\n        publishId: publication.publicationId,\n      };\n      return await getPublicationDetailAsync(projectRoot, detailOptions);\n    })\n  );\n\n  const uniqueRevisionIds = uniqBy(details, detail => detail.revisionId);\n  if (uniqueRevisionIds.length !== 1) {\n    // User probably applied some custom `publish:set` or `publish:rollback` command\n    return _getGenericUsage();\n  }\n\n  const { channel } = publishes[0];\n  const { revisionId, publishedTime, sdkVersion } = details[0];\n  const timeDifferenceString = _getTimeDifferenceString(new Date(), new Date(publishedTime));\n\n  return (\n    `--release-channel and either --sdk-version or --runtime-version arguments are required. \\n` +\n    `For example, to roll back the revision [${revisionId}] on release channel [${channel}] (published ${timeDifferenceString}), \\n` +\n    `run: expo publish:rollback --release-channel ${channel} --sdk-version ${sdkVersion}`\n  );\n}\n\nfunction _getTimeDifferenceString(t0: Date, t1: Date): string {\n  const minutesInMs = 60 * 1000;\n  const hourInMs = 60 * minutesInMs;\n  const dayInMs = 24 * hourInMs; // hours*minutes*seconds*milliseconds\n  const diffMs = Math.abs(t1.getTime() - t0.getTime());\n\n  const diffDays = Math.round(diffMs / dayInMs);\n  if (diffDays > 0) {\n    return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;\n  }\n\n  const diffHours = Math.round(diffMs / hourInMs);\n  if (diffHours > 0) {\n    return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;\n  }\n\n  const diffMinutes = Math.round(diffMs / minutesInMs);\n  if (diffMinutes > 0) {\n    return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;\n  }\n\n  return 'recently';\n}\n\nfunction _getGenericUsage(): string {\n  return (\n    `--release-channel and either --sdk-version or --runtime-version arguments are required. \\n` +\n    `For example, to roll back the latest publishes on the default channel for sdk 37.0.0, \\n` +\n    `run: expo publish:rollback --release-channel default --sdk-version 37.0.0 \\n` +\n    `To rollback a specific platform, use the --platform flag.`\n  );\n}\n"],"mappings":";;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAI+B;AAExB,eAAeA,aAAa,CAACC,WAAmB,EAAmB;EACxE,IAAI;IACF,OAAO,MAAMC,cAAc,CAACD,WAAW,CAAC;EAC1C,CAAC,CAAC,OAAOE,CAAM,EAAE;IACfC,cAAG,CAACC,IAAI,CAACF,CAAC,CAAC;IACX;IACA,OAAOG,gBAAgB,EAAE;EAC3B;AACF;AAEA,eAAeJ,cAAc,CAACD,WAAmB,EAAmB;EAClE,MAAMM,YAAY,GAAG,CAAC,KAAK,EAAE,SAAS,CAAC;EACvC,MAAMC,eAAe,GAAG,MAAM,IAAAC,sCAAsB,EAACR,WAAW,EAAE;IAChES,cAAc,EAAE,SAAS;IAAE;IAC3BC,KAAK,EAAEJ,YAAY,CAACK;EACtB,CAAC,CAAC;EACF,MAAMC,SAAS,GAAGL,eAAe,CAACM,WAA4B;;EAE9D;EACA,MAAMC,eAAe,GAAG,IAAAC,iBAAM,EAACH,SAAS,EAAEI,OAAO,IAAIA,OAAO,CAACC,QAAQ,CAAC;EACtE,IAAIH,eAAe,CAACH,MAAM,KAAKL,YAAY,CAACK,MAAM,EAAE;IAClD;IACA,OAAON,gBAAgB,EAAE;EAC3B;EAEA,MAAMa,OAAO,GAAG,MAAMC,OAAO,CAACC,GAAG,CAC/BR,SAAS,CAACS,GAAG,CAAC,MAAMC,WAAW,IAAI;IACjC,MAAMC,aAAa,GAAG;MACpBC,SAAS,EAAEF,WAAW,CAACG;IACzB,CAAC;IACD,OAAO,MAAM,IAAAC,yCAAyB,EAAC1B,WAAW,EAAEuB,aAAa,CAAC;EACpE,CAAC,CAAC,CACH;EAED,MAAMI,iBAAiB,GAAG,IAAAZ,iBAAM,EAACG,OAAO,EAAEU,MAAM,IAAIA,MAAM,CAACC,UAAU,CAAC;EACtE,IAAIF,iBAAiB,CAAChB,MAAM,KAAK,CAAC,EAAE;IAClC;IACA,OAAON,gBAAgB,EAAE;EAC3B;EAEA,MAAM;IAAEyB;EAAQ,CAAC,GAAGlB,SAAS,CAAC,CAAC,CAAC;EAChC,MAAM;IAAEiB,UAAU;IAAEE,aAAa;IAAEC;EAAW,CAAC,GAAGd,OAAO,CAAC,CAAC,CAAC;EAC5D,MAAMe,oBAAoB,GAAGC,wBAAwB,CAAC,IAAIC,IAAI,EAAE,EAAE,IAAIA,IAAI,CAACJ,aAAa,CAAC,CAAC;EAE1F,OACG,4FAA2F,GAC3F,2CAA0CF,UAAW,yBAAwBC,OAAQ,gBAAeG,oBAAqB,OAAM,GAC/H,gDAA+CH,OAAQ,kBAAiBE,UAAW,EAAC;AAEzF;AAEA,SAASE,wBAAwB,CAACE,EAAQ,EAAEC,EAAQ,EAAU;EAC5D,MAAMC,WAAW,GAAG,EAAE,GAAG,IAAI;EAC7B,MAAMC,QAAQ,GAAG,EAAE,GAAGD,WAAW;EACjC,MAAME,OAAO,GAAG,EAAE,GAAGD,QAAQ,CAAC,CAAC;EAC/B,MAAME,MAAM,GAAGC,IAAI,CAACC,GAAG,CAACN,EAAE,CAACO,OAAO,EAAE,GAAGR,EAAE,CAACQ,OAAO,EAAE,CAAC;EAEpD,MAAMC,QAAQ,GAAGH,IAAI,CAACI,KAAK,CAACL,MAAM,GAAGD,OAAO,CAAC;EAC7C,IAAIK,QAAQ,GAAG,CAAC,EAAE;IAChB,OAAQ,GAAEA,QAAS,OAAMA,QAAQ,KAAK,CAAC,GAAG,EAAE,GAAG,GAAI,MAAK;EAC1D;EAEA,MAAME,SAAS,GAAGL,IAAI,CAACI,KAAK,CAACL,MAAM,GAAGF,QAAQ,CAAC;EAC/C,IAAIQ,SAAS,GAAG,CAAC,EAAE;IACjB,OAAQ,GAAEA,SAAU,QAAOA,SAAS,KAAK,CAAC,GAAG,EAAE,GAAG,GAAI,MAAK;EAC7D;EAEA,MAAMC,WAAW,GAAGN,IAAI,CAACI,KAAK,CAACL,MAAM,GAAGH,WAAW,CAAC;EACpD,IAAIU,WAAW,GAAG,CAAC,EAAE;IACnB,OAAQ,GAAEA,WAAY,UAASA,WAAW,KAAK,CAAC,GAAG,EAAE,GAAG,GAAI,MAAK;EACnE;EAEA,OAAO,UAAU;AACnB;AAEA,SAAS3C,gBAAgB,GAAW;EAClC,OACG,4FAA2F,GAC3F,0FAAyF,GACzF,8EAA6E,GAC7E,2DAA0D;AAE/D"}