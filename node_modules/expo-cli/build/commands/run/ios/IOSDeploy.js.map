{"version":3,"file":"IOSDeploy.js","names":["isInstalledAsync","spawnAsync","stdio","installOnDeviceAsync","props","bundle","appDeltaDirectory","udid","deviceName","args","push","Log","debug","join","indicator","copyingFileCount","currentPhase","output","spawnIOSDeployAsync","message","loadingMatch","match","progress","tryParsingNumericValue","text","chalk","bold","startsWith","phaseMatch","phase","trim","PhaseNameMap","copiedMessage","gray","succeed","ora","start","code","fail","error","includes","appName","path","basename","split","program","nonInteractive","Prompts","confirmAsync","initial","CommandError","Install","Debug","Uninstall","str","parseInt","onStdout","Promise","resolve","reject","fork","spawn","errorOutput","stdout","on","data","stringData","toString","os","EOL","line","stderr","Buffer","assertInstalledAsync","cyan","brewInstallAsync","warn","wrapAnsi","process","columns","SilentError"],"sources":["../../../../src/commands/run/ios/IOSDeploy.ts"],"sourcesContent":["import spawnAsync from '@expo/spawn-async';\nimport chalk from 'chalk';\nimport { spawn } from 'child_process';\nimport program from 'commander';\nimport { Ora } from 'ora';\nimport os from 'os';\nimport path from 'path';\nimport wrapAnsi from 'wrap-ansi';\nimport { Prompts } from 'xdl';\n\nimport CommandError, { SilentError } from '../../../CommandError';\nimport Log from '../../../log';\nimport { ora } from '../../../utils/ora';\n\nexport async function isInstalledAsync() {\n  try {\n    await spawnAsync('ios-deploy', ['--version'], { stdio: 'ignore' });\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nexport async function installOnDeviceAsync(props: {\n  bundle: string;\n  appDeltaDirectory?: string;\n  udid: string;\n  deviceName: string;\n}): Promise<void> {\n  const { bundle, appDeltaDirectory, udid, deviceName } = props;\n  const args = [\n    '--bundle',\n    bundle,\n    '--id',\n    udid,\n    '--justlaunch',\n    // Wifi devices tend to stall and never resolve\n    '--no-wifi',\n  ];\n  if (appDeltaDirectory) {\n    args.push('--app_deltas', appDeltaDirectory);\n  }\n  // TODO: Attach LLDB debugger for native logs\n  // '--debug'\n\n  Log.debug(`  ios-deploy ${args.join(' ')}`);\n\n  let indicator: Ora | undefined;\n  let copyingFileCount = 0;\n  let currentPhase: string | undefined;\n  const output = await spawnIOSDeployAsync(args, message => {\n    const loadingMatch = message.match(/\\[(.*?)\\] (.*)/m);\n    if (loadingMatch) {\n      const progress = tryParsingNumericValue(loadingMatch[1]);\n      const message = loadingMatch[2];\n      if (indicator) {\n        indicator.text = `${chalk.bold(currentPhase)} ${progress}%`;\n      }\n      if (message.startsWith('Copying ')) {\n        copyingFileCount++;\n      }\n      return;\n    }\n    // Install, Debug, Uninstall\n    const phaseMatch = message.match(/------\\s(\\w+) phase\\s------/m);\n    if (phaseMatch) {\n      let phase = phaseMatch[1]?.trim?.();\n      // Remap name\n      phase = PhaseNameMap[phase] ?? phase;\n\n      if (indicator) {\n        if (currentPhase === 'Installing') {\n          const copiedMessage = chalk.gray`Copied ${copyingFileCount} file(s)`;\n          // Emulate Xcode copy file count, this helps us know if app deltas are working.\n          indicator.succeed(`${chalk.bold('Installed')} ${copiedMessage}`);\n        } else {\n          indicator.succeed();\n        }\n      }\n      indicator = ora(phase).start();\n      currentPhase = phase;\n      return;\n    }\n    Log.debug(message);\n  });\n\n  if (output.code !== 0) {\n    if (indicator) {\n      indicator.fail();\n    }\n    // Allow users to unlock their phone and try the launch over again.\n    if (output.error.includes('The device is locked')) {\n      // Get the app name from the binary path.\n      const appName = path.basename(bundle).split('.')[0] ?? 'app';\n      if (\n        !program.nonInteractive &&\n        (await Prompts.confirmAsync({\n          message: `Cannot launch ${appName} because the device is locked. Unlock ${deviceName} to continue...`,\n          initial: true,\n        }))\n      ) {\n        return installOnDeviceAsync(props);\n      } else {\n        throw new CommandError(\n          `Cannot launch ${appName} on ${deviceName} because the device is locked.`\n        );\n      }\n    }\n    throw new CommandError(\n      `Failed to install the app on device. Error in \"ios-deploy\" command: ${output.error}`\n    );\n  } else {\n    if (indicator) {\n      if (currentPhase === 'Launching') {\n        indicator.succeed(`${chalk.bold`Launched`} ${chalk.gray(`on ${deviceName}`)}`);\n      } else {\n        indicator.succeed();\n      }\n    }\n  }\n}\n\nconst PhaseNameMap: Record<string, string> = {\n  Install: 'Installing',\n  Debug: 'Launching',\n  Uninstall: 'Uninstalling',\n};\n\nfunction tryParsingNumericValue(str?: string): number | null {\n  try {\n    return parseInt(str?.match(/\\d+/)?.[0] ?? '-1', 10);\n  } catch {\n    return -1;\n  }\n}\n\nfunction spawnIOSDeployAsync(args: string[], onStdout: (message: string) => void) {\n  return new Promise<{ output: string; error: string; code: number }>(async (resolve, reject) => {\n    const fork = spawn('ios-deploy', args);\n    let output = '';\n    let errorOutput = '';\n    fork.stdout.on('data', (data: Buffer) => {\n      const stringData = data.toString().split(os.EOL);\n      for (let line of stringData) {\n        line = line.trim();\n        if (!line) continue;\n        if (line.match(/Error: /)) {\n          errorOutput = line;\n        } else {\n          output += line;\n          onStdout(line);\n        }\n      }\n    });\n\n    fork.stderr.on('data', (data: Buffer) => {\n      const stringData = data instanceof Buffer ? data.toString() : data;\n      errorOutput += stringData;\n    });\n\n    fork.on('close', (code: number) => {\n      resolve({ output, error: errorOutput, code });\n    });\n  });\n}\n\nexport async function assertInstalledAsync() {\n  if (!(await isInstalledAsync())) {\n    if (\n      await Prompts.confirmAsync({\n        message: `Required package ${chalk.cyan`ios-deploy`} is not installed, would you like to try installing it with homebrew?`,\n        initial: true,\n      })\n    ) {\n      try {\n        await brewInstallAsync();\n        return;\n      } catch (error: any) {\n        Log.error(`Failed to install ${chalk.bold`ios-deploy`} with homebrew: ${error.message}`);\n      }\n    }\n    // Controlled error message.\n    const error = `Cannot install iOS apps on devices without ${chalk.bold`ios-deploy`} installed globally. Please install it with ${chalk.bold`brew install ios-deploy`} and try again, or build the app with a simulator.`;\n    Log.warn(wrapAnsi(error, process.stdout.columns || 80));\n    throw new SilentError(error);\n  }\n}\n\nasync function brewInstallAsync() {\n  await spawnAsync('brew', ['install', 'ios-deploy'], {\n    stdio: 'inherit',\n  });\n}\n"],"mappings":"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"}