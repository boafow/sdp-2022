{"version":3,"file":"developmentCodeSigning.js","names":["getLastDeveloperCodeSigningIdAsync","developmentCodeSigningId","UserSettings","readAsync","setLastDeveloperCodeSigningIdAsync","id","setAsync","catch","getCodeSigningInfoForPbxproj","projectRoot","project","IOSConfig","XcodeUtils","getPbxproj","targets","Target","findSignableTargets","signingInfo","nativeTargetId","nativeTarget","developmentTeams","provisioningProfiles","getBuildConfigurationsForListId","buildConfigurationList","filter","item","buildSettings","PRODUCT_NAME","forEach","DEVELOPMENT_TEAM","PROVISIONING_PROFILE","push","setAutoCodeSigningInfoForPbxproj","appleTeamId","quotedAppleTeamId","ensureQuotes","CODE_SIGN_IDENTITY","CODE_SIGN_STYLE","Object","entries","getProjectSection","isNotComment","attributes","TargetAttributes","DevelopmentTeam","ProvisioningStyle","fs","writeFileSync","filepath","writeSync","value","match","ensureDeviceIsCodeSignedForDeploymentAsync","allTargetsHaveTeams","values","reduce","prev","curr","length","teamList","concat","Log","log","chalk","dim","join","allTargetsHaveProfiles","Security","assertInstalledAsync","ids","findIdentitiesAsync","selectCertificateSigningIdentityAsync","codeSigningInfo","sortDefaultIdToBeginningAsync","identities","lastSelected","iterations","signingCertificateId","shift","addNewLineIfNone","bold","learnMore","newLine","CommandError","program","nonInteractive","resolveCertificateSigningInfoAsync","preferred","resolveIdentitiesAsync","index","selectAsync","message","choices","map","i","format","title","appleTeamName","selected"],"sources":["../../../../src/commands/run/ios/developmentCodeSigning.ts"],"sourcesContent":["import { IOSConfig } from '@expo/config-plugins';\nimport chalk from 'chalk';\nimport program from 'commander';\nimport * as fs from 'fs-extra';\nimport { UserSettings } from 'xdl';\n\nimport CommandError from '../../../CommandError';\nimport Log from '../../../log';\nimport { selectAsync } from '../../../utils/prompts';\nimport { learnMore } from '../../utils/TerminalLink';\nimport * as Security from '../utils/Security';\n\nasync function getLastDeveloperCodeSigningIdAsync() {\n  const { developmentCodeSigningId } = await UserSettings.readAsync();\n  return developmentCodeSigningId;\n}\n\nasync function setLastDeveloperCodeSigningIdAsync(id: string) {\n  await UserSettings.setAsync('developmentCodeSigningId', id).catch(() => {});\n}\n\n/**\n * Find the development team and provisioning profile that's currently in use by the Xcode project.\n *\n * @param projectRoot\n * @returns\n */\nexport function getCodeSigningInfoForPbxproj(projectRoot: string) {\n  const project = IOSConfig.XcodeUtils.getPbxproj(projectRoot);\n  const targets = IOSConfig.Target.findSignableTargets(project);\n\n  const signingInfo: Record<\n    string,\n    { developmentTeams: string[]; provisioningProfiles: string[] }\n  > = {};\n  for (const [nativeTargetId, nativeTarget] of targets) {\n    const developmentTeams: string[] = [];\n    const provisioningProfiles: string[] = [];\n\n    IOSConfig.XcodeUtils.getBuildConfigurationsForListId(\n      project,\n      nativeTarget.buildConfigurationList\n    )\n      .filter(\n        ([, item]: IOSConfig.XcodeUtils.ConfigurationSectionEntry) =>\n          item.buildSettings.PRODUCT_NAME\n      )\n      .forEach(([, item]: IOSConfig.XcodeUtils.ConfigurationSectionEntry) => {\n        const { DEVELOPMENT_TEAM, PROVISIONING_PROFILE } = item.buildSettings;\n        if (\n          typeof DEVELOPMENT_TEAM === 'string' &&\n          // If the user selects \"Team: none\" in Xcode, it'll be an empty string.\n          !!DEVELOPMENT_TEAM &&\n          // xcode package sometimes reads an empty string as a quoted empty string.\n          DEVELOPMENT_TEAM !== '\"\"'\n        ) {\n          developmentTeams.push(DEVELOPMENT_TEAM);\n        }\n        if (typeof PROVISIONING_PROFILE === 'string' && !!PROVISIONING_PROFILE) {\n          provisioningProfiles.push(PROVISIONING_PROFILE);\n        }\n      });\n    signingInfo[nativeTargetId] = {\n      developmentTeams,\n      provisioningProfiles,\n    };\n  }\n\n  return signingInfo;\n}\n\n/**\n * Set the development team and configure the Xcode project for automatic code signing,\n * this helps us resolve the code signing on subsequent runs and emulates Xcode behavior.\n *\n * @param projectRoot\n * @param props.appleTeamId\n */\nfunction setAutoCodeSigningInfoForPbxproj(\n  projectRoot: string,\n  { appleTeamId }: { appleTeamId: string }\n): void {\n  const project = IOSConfig.XcodeUtils.getPbxproj(projectRoot);\n  const targets = IOSConfig.Target.findSignableTargets(project);\n\n  const quotedAppleTeamId = ensureQuotes(appleTeamId);\n\n  for (const [nativeTargetId, nativeTarget] of targets) {\n    IOSConfig.XcodeUtils.getBuildConfigurationsForListId(\n      project,\n      nativeTarget.buildConfigurationList\n    )\n      .filter(\n        ([, item]: IOSConfig.XcodeUtils.ConfigurationSectionEntry) =>\n          item.buildSettings.PRODUCT_NAME\n      )\n      .forEach(([, item]: IOSConfig.XcodeUtils.ConfigurationSectionEntry) => {\n        item.buildSettings.DEVELOPMENT_TEAM = quotedAppleTeamId;\n        item.buildSettings.CODE_SIGN_IDENTITY = '\"Apple Development\"';\n        item.buildSettings.CODE_SIGN_STYLE = 'Automatic';\n      });\n\n    Object.entries(IOSConfig.XcodeUtils.getProjectSection(project))\n      .filter(IOSConfig.XcodeUtils.isNotComment)\n      .forEach(([, item]: IOSConfig.XcodeUtils.ProjectSectionEntry) => {\n        if (!item.attributes.TargetAttributes[nativeTargetId]) {\n          item.attributes.TargetAttributes[nativeTargetId] = {};\n        }\n\n        item.attributes.TargetAttributes[nativeTargetId].DevelopmentTeam = quotedAppleTeamId;\n        item.attributes.TargetAttributes[nativeTargetId].ProvisioningStyle = 'Automatic';\n      });\n  }\n\n  fs.writeFileSync(project.filepath, project.writeSync());\n}\n\nconst ensureQuotes = (value: string) => {\n  if (!value.match(/^['\"]/)) {\n    return `\"${value}\"`;\n  }\n  return value;\n};\n\nexport async function ensureDeviceIsCodeSignedForDeploymentAsync(\n  projectRoot: string\n): Promise<string | null> {\n  // Check if the app already has a development team defined.\n  const signingInfo = getCodeSigningInfoForPbxproj(projectRoot);\n\n  const allTargetsHaveTeams = Object.values(signingInfo).reduce((prev, curr) => {\n    return prev && !!curr.developmentTeams.length;\n  }, true);\n\n  if (allTargetsHaveTeams) {\n    const teamList = Object.values(signingInfo).reduce<string[]>((prev, curr) => {\n      return prev.concat([curr.developmentTeams[0]]);\n    }, []);\n    Log.log(chalk.dim`\\u203A Auto signing app using team(s): ${teamList.join(', ')}`);\n    return null;\n  }\n\n  const allTargetsHaveProfiles = Object.values(signingInfo).reduce((prev, curr) => {\n    return prev && !!curr.provisioningProfiles.length;\n  }, true);\n  if (allTargetsHaveProfiles) {\n    // this indicates that the user has manual code signing setup (possibly for production).\n    return null;\n  }\n\n  // Only assert if the project needs to be signed.\n  await Security.assertInstalledAsync();\n\n  const ids = await Security.findIdentitiesAsync();\n\n  const id = await selectCertificateSigningIdentityAsync(ids);\n\n  Log.log(`\\u203A Signing and building iOS app with: ${id.codeSigningInfo}`);\n\n  setAutoCodeSigningInfoForPbxproj(projectRoot, {\n    appleTeamId: id.appleTeamId!,\n  });\n  return id.appleTeamId!;\n}\n\n/**\n * Sort the code signing items so the last selected item (user's default) is the first suggested.\n */\nasync function sortDefaultIdToBeginningAsync(\n  identities: Security.CertificateSigningInfo[]\n): Promise<[Security.CertificateSigningInfo[], string | undefined]> {\n  const lastSelected = await getLastDeveloperCodeSigningIdAsync();\n\n  if (lastSelected) {\n    let iterations = 0;\n    while (identities[0].signingCertificateId !== lastSelected && iterations < identities.length) {\n      identities.push(identities.shift()!);\n      iterations++;\n    }\n  }\n  return [identities, lastSelected];\n}\n\nasync function selectCertificateSigningIdentityAsync(ids: string[]) {\n  // The user has no valid code signing identities.\n  if (!ids.length) {\n    // TODO: We can probably do this too.\n    Log.addNewLineIfNone();\n    Log.log(\n      `\\u203A Your computer requires some additional setup before you can build onto physical iOS devices.\\n  ${chalk.bold(\n        learnMore('https://expo.fyi/setup-xcode-signing')\n      )}`\n    );\n    Log.newLine();\n    throw new CommandError('No code signing certificates are available to use.');\n  }\n\n  //  One ID available 🤝 Program is not interactive\n  //\n  //     using the the first available option\n  if (ids.length === 1 || program.nonInteractive) {\n    return Security.resolveCertificateSigningInfoAsync(ids[0]);\n  }\n\n  // Get identities and sort by the one that the user is most likely to choose.\n  const [identities, preferred] = await sortDefaultIdToBeginningAsync(\n    await Security.resolveIdentitiesAsync(ids)\n  );\n\n  const index = await selectAsync({\n    message: 'Development team for signing the app',\n    choices: identities.map((value, i) => {\n      const format =\n        value.signingCertificateId === preferred ? chalk.bold : (message: string) => message;\n      return {\n        // Formatted like: `650 Industries, Inc. (A1BCDEF234) - Apple Development: Evan Bacon (AA00AABB0A)`\n        title: format(\n          [value.appleTeamName, `(${value.appleTeamId}) -`, value.codeSigningInfo].join(' ')\n        ),\n        value: i,\n      };\n    }),\n  });\n\n  const selected = identities[index];\n\n  // Store the last used value and suggest it as the first value\n  // next time the user has to select a code signing identity.\n  await setLastDeveloperCodeSigningIdAsync(selected.signingCertificateId);\n\n  return selected;\n}\n"],"mappings":"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"}