{"version":3,"file":"runIos.js","names":["isMac","process","platform","actionAsync","projectRoot","options","warnAboutLocalCLI","localCmd","profileMethod","promptToClearMalformedNativeProjectsAsync","exp","getConfig","skipSDKVersionRequirement","track","Log","warn","chalk","cyan","fs","existsSync","path","join","prebuildAsync","install","platforms","maybePromptToSyncPodsAsync","props","resolveOptionsAsync","isSimulator","AppleDevice","isEnabled","log","gray","bold","IOSDeploy","assertInstalledAsync","buildOutput","XcodeBuild","buildAsync","binaryPath","getAppBinaryPath","setGlobalDevClientSettingsAsync","shouldStartBundler","startBundlerAsync","metroPort","port","bundleIdentifier","getBundleIdentifierForBinaryAsync","logPrettyItem","device","name","SimControl","installAsync","udid","dir","openInSimulatorAsync","installOnDeviceAsync","bundle","appDeltaDirectory","getAppDeltaDirectory","deviceName","nested","dim","UnifiedAnalytics","logEvent","status","getDevClientProperties","StatusEventEmitter","once","installCustomExitHook","flush","builtInfoPlistPath","CFBundleIdentifier","parseBinaryPlistAsync","Simulator","streamLogsAsync","schemes","getSchemesForIosAsync","result","openProjectAsync","devClient","scheme","applicationId","skipNativeLogs","success","CommandError","error"],"sources":["../../../../src/commands/run/ios/runIos.ts"],"sourcesContent":["import { ExpoConfig, getConfig } from '@expo/config';\nimport chalk from 'chalk';\nimport fs from 'fs-extra';\nimport * as path from 'path';\nimport { AppleDevice, SimControl, Simulator, UnifiedAnalytics } from 'xdl';\n\nimport CommandError from '../../../CommandError';\nimport StatusEventEmitter from '../../../analytics/StatusEventEmitter';\nimport getDevClientProperties from '../../../analytics/getDevClientProperties';\nimport Log from '../../../log';\nimport { warnAboutLocalCLI } from '../../../utils/migration';\nimport { promptToClearMalformedNativeProjectsAsync } from '../../eject/clearNativeFolder';\nimport { EjectAsyncOptions, prebuildAsync } from '../../eject/prebuildAppAsync';\nimport { installCustomExitHook } from '../../start/installExitHooks';\nimport { profileMethod } from '../../utils/profileMethod';\nimport { setGlobalDevClientSettingsAsync, startBundlerAsync } from '../ios/startBundlerAsync';\nimport { parseBinaryPlistAsync } from '../utils/binaryPlist';\nimport { getSchemesForIosAsync } from '../utils/schemes';\nimport * as IOSDeploy from './IOSDeploy';\nimport maybePromptToSyncPodsAsync from './Podfile';\nimport * as XcodeBuild from './XcodeBuild';\nimport { getAppDeltaDirectory, installOnDeviceAsync } from './installOnDeviceAsync';\nimport { Options, resolveOptionsAsync } from './resolveOptionsAsync';\n\nconst isMac = process.platform === 'darwin';\n\nexport async function actionAsync(projectRoot: string, options: Options) {\n  warnAboutLocalCLI(projectRoot, { localCmd: 'run:ios' });\n\n  // If the user has an empty ios folder then the project won't build, this can happen when they delete the prebuild files in git.\n  // Check to ensure most of the core files are in place, and prompt to remove the folder if they aren't.\n  await profileMethod(promptToClearMalformedNativeProjectsAsync)(projectRoot, ['ios']);\n\n  const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n  track(projectRoot, exp);\n\n  if (!isMac) {\n    // TODO: Prompt to use EAS?\n\n    Log.warn(\n      `iOS apps can only be built on macOS devices. Use ${chalk.cyan`eas build -p ios`} to build in the cloud.`\n    );\n    return;\n  }\n\n  // If the project doesn't have native code, prebuild it...\n  if (!fs.existsSync(path.join(projectRoot, 'ios'))) {\n    await prebuildAsync(projectRoot, {\n      install: options.install,\n      platforms: ['ios'],\n    } as EjectAsyncOptions);\n  } else if (options.install) {\n    await maybePromptToSyncPodsAsync(projectRoot);\n    // TODO: Ensure the pods are in sync -- https://github.com/expo/expo/pull/11593\n  }\n\n  const props = await resolveOptionsAsync(projectRoot, options);\n  if (!props.isSimulator) {\n    if (AppleDevice.isEnabled()) {\n      Log.log(\n        chalk.gray(\n          `\\u203A Unstable feature ${chalk.bold`EXPO_USE_APPLE_DEVICE`} is enabled. Device installation may not work as expected.`\n        )\n      );\n    } else {\n      // Assert as early as possible\n      await IOSDeploy.assertInstalledAsync();\n    }\n  }\n\n  const buildOutput = await profileMethod(XcodeBuild.buildAsync, 'XcodeBuild.buildAsync')(props);\n\n  const binaryPath = await profileMethod(\n    XcodeBuild.getAppBinaryPath,\n    'XcodeBuild.getAppBinaryPath'\n  )(buildOutput);\n\n  await setGlobalDevClientSettingsAsync(projectRoot);\n  if (props.shouldStartBundler) {\n    await startBundlerAsync(projectRoot, {\n      metroPort: props.port,\n      platforms: exp.platforms,\n    });\n  }\n  const bundleIdentifier = await profileMethod(getBundleIdentifierForBinaryAsync)(binaryPath);\n\n  if (props.isSimulator) {\n    XcodeBuild.logPrettyItem(`${chalk.bold`Installing`} on ${props.device.name}`);\n    await SimControl.installAsync({ udid: props.device.udid, dir: binaryPath });\n\n    await openInSimulatorAsync({\n      projectRoot,\n      bundleIdentifier,\n      device: props.device,\n      shouldStartBundler: props.shouldStartBundler,\n    });\n  } else {\n    await profileMethod(installOnDeviceAsync)({\n      bundleIdentifier,\n      bundle: binaryPath,\n      appDeltaDirectory: getAppDeltaDirectory(bundleIdentifier),\n      udid: props.device.udid,\n      deviceName: props.device.name,\n    });\n  }\n\n  if (props.shouldStartBundler) {\n    Log.nested(`\\nLogs for your project will appear below. ${chalk.dim(`Press Ctrl+C to exit.`)}`);\n  }\n}\n\nfunction track(projectRoot: string, exp: ExpoConfig) {\n  UnifiedAnalytics.logEvent('dev client run command', {\n    status: 'started',\n    platform: 'ios',\n    ...getDevClientProperties(projectRoot, exp),\n  });\n  StatusEventEmitter.once('bundleBuildFinish', () => {\n    // Send the 'bundle ready' event once the JS has been built.\n    UnifiedAnalytics.logEvent('dev client run command', {\n      status: 'bundle ready',\n      platform: 'ios',\n      ...getDevClientProperties(projectRoot, exp),\n    });\n  });\n  StatusEventEmitter.once('deviceLogReceive', () => {\n    // Send the 'ready' event once the app is running in a device.\n    UnifiedAnalytics.logEvent('dev client run command', {\n      status: 'ready',\n      platform: 'ios',\n      ...getDevClientProperties(projectRoot, exp),\n    });\n  });\n  installCustomExitHook(() => {\n    UnifiedAnalytics.logEvent('dev client run command', {\n      status: 'finished',\n      platform: 'ios',\n      ...getDevClientProperties(projectRoot, exp),\n    });\n    UnifiedAnalytics.flush();\n  });\n}\n\nasync function getBundleIdentifierForBinaryAsync(binaryPath: string): Promise<string> {\n  const builtInfoPlistPath = path.join(binaryPath, 'Info.plist');\n  const { CFBundleIdentifier } = await parseBinaryPlistAsync(builtInfoPlistPath);\n  return CFBundleIdentifier;\n}\n\nasync function openInSimulatorAsync({\n  projectRoot,\n  bundleIdentifier,\n  device,\n  shouldStartBundler,\n}: {\n  projectRoot: string;\n  bundleIdentifier: string;\n  device: XcodeBuild.BuildProps['device'];\n  shouldStartBundler?: boolean;\n}) {\n  XcodeBuild.logPrettyItem(\n    `${chalk.bold`Opening`} on ${device.name} ${chalk.dim(`(${bundleIdentifier})`)}`\n  );\n\n  if (shouldStartBundler) {\n    await Simulator.streamLogsAsync({\n      udid: device.udid,\n      bundleIdentifier,\n    });\n  }\n\n  const schemes = await getSchemesForIosAsync(projectRoot);\n  const result = await Simulator.openProjectAsync({\n    projectRoot,\n    udid: device.udid,\n    devClient: true,\n    scheme: schemes[0],\n    applicationId: bundleIdentifier,\n    // We always setup native logs before launching to ensure we catch any fatal errors.\n    skipNativeLogs: true,\n  });\n  if (!result.success) {\n    throw new CommandError(result.error);\n  }\n}\n"],"mappings":"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"}