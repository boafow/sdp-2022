{"version":3,"file":"parseStartOptions.js","names":["hasBooleanArg","rawArgs","argName","includes","getBooleanArg","setBooleanArg","fallback","warnUsingDeprecatedArgs","deprecatedArgs","arg","message","Log","warn","chalk","bold","normalizeOptionsAsync","projectRoot","options","parent","opts","parseRawArguments","webOnly","webpackPort","resolvePortAsync","defaultPort","port","fallbackPort","WebpackEnvironment","DEFAULT_PORT","AbortCommandError","metroPort","devClient","cacheOptionsAsync","nonInteractive","dev","minify","https","android","ios","web","localhost","lan","tunnel","ProjectSettings","setAsync","scheme","parseStartOptions","exp","startOpts","platforms","clear","reset","maxWorkers","forceManifestType","undefined","easUpdatesUrlRegex","updatesUrl","updates","url","isEasUpdatesUrl","test","isLegacyImportsEnabled","target","debug","Versions","lteSdkVersion","isRemoteReloadingEnabled","isWebSocketsEnabled"],"sources":["../../../src/commands/start/parseStartOptions.ts"],"sourcesContent":["import { ExpoConfig, isLegacyImportsEnabled } from '@expo/config';\nimport chalk from 'chalk';\nimport { Project, ProjectSettings, Versions } from 'xdl';\nimport * as WebpackEnvironment from 'xdl/build/webpack-utils/WebpackEnvironment';\n\nimport { AbortCommandError } from '../../CommandError';\nimport Log from '../../log';\nimport { resolvePortAsync } from '../run/utils/resolvePortAsync';\nimport { URLOptions } from '../utils/urlOpts';\n\nexport type NormalizedOptions = URLOptions & {\n  webOnly?: boolean;\n  dev?: boolean;\n  minify?: boolean;\n  https?: boolean;\n  nonInteractive?: boolean;\n  clear?: boolean;\n  maxWorkers?: number;\n  sendTo?: string;\n  host?: string;\n  lan?: boolean;\n  localhost?: boolean;\n  tunnel?: boolean;\n  metroPort?: number;\n  webpackPort?: number;\n  forceManifestType?: string;\n};\n\nexport type RawStartOptions = NormalizedOptions & {\n  port?: number;\n  parent?: { nonInteractive: boolean; rawArgs: string[] };\n};\n\nfunction hasBooleanArg(rawArgs: string[], argName: string): boolean {\n  return rawArgs.includes('--' + argName) || rawArgs.includes('--no-' + argName);\n}\n\nfunction getBooleanArg(rawArgs: string[], argName: string): boolean {\n  if (rawArgs.includes('--' + argName)) {\n    return true;\n  } else {\n    return false;\n  }\n}\n\nexport function setBooleanArg(\n  argName: string,\n  rawArgs: string[],\n  fallback?: boolean\n): boolean | undefined {\n  if (rawArgs.includes(`--${argName}`)) {\n    return true;\n  } else if (rawArgs.includes(`--no-${argName}`)) {\n    return false;\n  } else {\n    return fallback;\n  }\n}\n\n// TODO: Deprecate these features sometime around the versioned migration.\nfunction warnUsingDeprecatedArgs(rawArgs: string[]) {\n  const deprecatedArgs = [\n    ['--no-https', 'Https is disabled by default.'],\n    ['--no-minify', 'Minify is disabled by default.'],\n    ['--dev', 'Dev is enabled by default.'],\n  ];\n\n  for (const [arg, message] of deprecatedArgs) {\n    if (rawArgs.includes(arg)) {\n      Log.warn(`\\u203A The ${chalk.bold(arg)} flag is deprecated. ${message}`);\n    }\n  }\n}\n\n// The main purpose of this function is to take existing options object and\n// support boolean args with as defined in the hasBooleanArg and getBooleanArg\n// functions.\nexport async function normalizeOptionsAsync(\n  projectRoot: string,\n  options: RawStartOptions\n): Promise<NormalizedOptions> {\n  const rawArgs = options.parent?.rawArgs || [];\n  warnUsingDeprecatedArgs(rawArgs);\n  const opts = parseRawArguments(options, rawArgs);\n\n  if (options.webOnly) {\n    const webpackPort = await resolvePortAsync(projectRoot, {\n      defaultPort: options.port,\n      fallbackPort: WebpackEnvironment.DEFAULT_PORT,\n    });\n    if (!webpackPort) {\n      throw new AbortCommandError();\n    }\n    opts.webpackPort = webpackPort;\n  } else {\n    const metroPort = await resolvePortAsync(projectRoot, {\n      defaultPort: options.port,\n      fallbackPort: options.devClient ? 8081 : 19000,\n    });\n    if (!metroPort) {\n      throw new AbortCommandError();\n    }\n    opts.metroPort = metroPort;\n  }\n\n  // Side-effect\n  await cacheOptionsAsync(projectRoot, opts);\n\n  return opts;\n}\n\n// The main purpose of this function is to take existing options object and\n// support boolean args with as defined in the hasBooleanArg and getBooleanArg\n// functions.\nexport function parseRawArguments(options: RawStartOptions, rawArgs: string[]): NormalizedOptions {\n  const opts: NormalizedOptions = {\n    ...options, // This is necessary to ensure we don't drop any options\n    webOnly: !!options.webOnly, // This is only ever true in the start:web command\n    nonInteractive: options.parent?.nonInteractive,\n    // setBooleanArg is used to flip the default commander logic which automatically sets a value to `true` if the inverse option isn't provided.\n    // ex: `dev == true` if `--no-dev` is a possible flag, but `--no-dev` was not provided in the command.\n    dev: setBooleanArg('dev', rawArgs, true),\n    minify: setBooleanArg('minify', rawArgs, false),\n    https: setBooleanArg('https', rawArgs, false),\n  };\n\n  if (hasBooleanArg(rawArgs, 'android')) {\n    opts.android = getBooleanArg(rawArgs, 'android');\n  }\n\n  if (hasBooleanArg(rawArgs, 'ios')) {\n    opts.ios = getBooleanArg(rawArgs, 'ios');\n  }\n\n  if (hasBooleanArg(rawArgs, 'web')) {\n    opts.web = getBooleanArg(rawArgs, 'web');\n  }\n\n  if (hasBooleanArg(rawArgs, 'localhost')) {\n    opts.localhost = getBooleanArg(rawArgs, 'localhost');\n  }\n\n  if (hasBooleanArg(rawArgs, 'lan')) {\n    opts.lan = getBooleanArg(rawArgs, 'lan');\n  }\n\n  if (hasBooleanArg(rawArgs, 'tunnel')) {\n    opts.tunnel = getBooleanArg(rawArgs, 'tunnel');\n  }\n\n  return opts;\n}\n\nasync function cacheOptionsAsync(projectRoot: string, options: NormalizedOptions): Promise<void> {\n  await ProjectSettings.setAsync(projectRoot, {\n    devClient: options.devClient,\n    scheme: options.scheme,\n    dev: options.dev,\n    minify: options.minify,\n    https: options.https,\n  });\n}\n\nexport function parseStartOptions(\n  options: NormalizedOptions,\n  exp: ExpoConfig\n): Project.StartOptions {\n  const startOpts: Project.StartOptions = {\n    metroPort: options.metroPort,\n    webpackPort: options.webpackPort,\n    platforms: exp.platforms ?? ['ios', 'android', 'web'],\n  };\n\n  if (options.clear) {\n    startOpts.reset = true;\n  }\n\n  if (options.nonInteractive) {\n    startOpts.nonInteractive = true;\n  }\n\n  if (options.webOnly) {\n    startOpts.webOnly = true;\n  }\n\n  if (options.maxWorkers) {\n    startOpts.maxWorkers = options.maxWorkers;\n  }\n\n  if (options.devClient) {\n    startOpts.devClient = true;\n  }\n\n  if (options.forceManifestType) {\n    startOpts.forceManifestType =\n      options.forceManifestType === 'classic'\n        ? 'classic'\n        : options.forceManifestType === 'expo-updates'\n        ? 'expo-updates'\n        : undefined;\n  } else {\n    const easUpdatesUrlRegex = /^https:\\/\\/(staging-)?u\\.expo\\.dev/;\n    const updatesUrl = exp.updates?.url;\n    const isEasUpdatesUrl = updatesUrl && easUpdatesUrlRegex.test(updatesUrl);\n\n    startOpts.forceManifestType = isEasUpdatesUrl ? 'expo-updates' : 'classic';\n  }\n\n  if (isLegacyImportsEnabled(exp)) {\n    // For `expo start`, the default target is 'managed', for both managed *and* bare apps.\n    // See: https://docs.expo.dev/bare/using-expo-client\n    startOpts.target = options.devClient ? 'bare' : 'managed';\n    Log.debug('Using target: ', startOpts.target);\n  }\n\n  // The SDK 41 client has web socket support.\n  if (!Versions.lteSdkVersion(exp, '40.0.0')) {\n    startOpts.isRemoteReloadingEnabled = true;\n    if (!startOpts.webOnly) {\n      startOpts.isWebSocketsEnabled = true;\n    }\n  }\n\n  return startOpts;\n}\n"],"mappings":"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"}