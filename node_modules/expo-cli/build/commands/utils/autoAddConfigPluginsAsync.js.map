{"version":3,"file":"autoAddConfigPluginsAsync.js","names":["packageHasConfigPlugin","projectRoot","packageName","info","resolveConfigPluginFunctionWithInfo","isPluginFile","plugin","getNamedPlugins","plugins","namedPlugins","normal","normalizeStaticPlugin","push","autoPlugins","getAutoPlugins","autoAddConfigPluginsAsync","exp","packages","Log","debug","currentPlugins","normalized","join","filter","pkg","includes","length","attemptAddingPluginsAsync"],"sources":["../../../src/commands/utils/autoAddConfigPluginsAsync.ts"],"sourcesContent":["import { ExpoConfig } from '@expo/config';\nimport {\n  normalizeStaticPlugin,\n  resolveConfigPluginFunctionWithInfo,\n} from '@expo/config-plugins/build/utils/plugin-resolver';\nimport { getAutoPlugins } from '@expo/prebuild-config';\n\nimport Log from '../../log';\nimport { attemptAddingPluginsAsync } from './modifyConfigAsync';\n\n/**\n * Resolve if a package has a config plugin.\n * For sanity, we'll only support config plugins that use the `app.config.js` entry file,\n * this is because a package like `lodash` could be a \"valid\" config plugin and break the prebuild process.\n *\n * @param projectRoot\n * @param packageName\n * @returns\n */\nfunction packageHasConfigPlugin(projectRoot: string, packageName: string) {\n  try {\n    const info = resolveConfigPluginFunctionWithInfo(projectRoot, packageName);\n    if (info.isPluginFile) {\n      return info.plugin;\n    }\n  } catch {}\n  return false;\n}\n\nexport function getNamedPlugins(plugins: NonNullable<ExpoConfig['plugins']>): string[] {\n  const namedPlugins = [];\n  for (const plugin of plugins) {\n    try {\n      // @ts-ignore\n      const [normal] = normalizeStaticPlugin(plugin);\n      if (typeof normal === 'string') {\n        namedPlugins.push(normal);\n      }\n    } catch {\n      // ignore assertions\n    }\n  }\n  return namedPlugins;\n}\n\nconst autoPlugins = getAutoPlugins();\n\nexport async function autoAddConfigPluginsAsync(\n  projectRoot: string,\n  exp: Pick<ExpoConfig, 'plugins'>,\n  packages: string[]\n) {\n  Log.debug('Checking config plugins...');\n\n  const currentPlugins = exp.plugins || [];\n  const normalized = getNamedPlugins(currentPlugins);\n\n  Log.debug(`Existing plugins: ${normalized.join(', ')}`);\n\n  const plugins = packages.filter(pkg => {\n    if (normalized.includes(pkg)) {\n      // already included in plugins array\n      return false;\n    }\n    // Check if the package has a valid plugin. Must be a well-made plugin for it to work with this.\n    const plugin = packageHasConfigPlugin(projectRoot, pkg);\n\n    Log.debug(\n      `Package \"${pkg}\" has plugin: ${!!plugin}` + (plugin ? ` (args: ${plugin.length})` : '')\n    );\n\n    if (autoPlugins.includes(pkg)) {\n      Log.debug(`Package \"${pkg}\" is an auto plugin, skipping...`);\n      return false;\n    }\n\n    return !!plugin;\n  });\n\n  await attemptAddingPluginsAsync(projectRoot, exp, plugins);\n}\n"],"mappings":";;;;;;;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAIA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAAgE;AAEhE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASA,sBAAsB,CAACC,WAAmB,EAAEC,WAAmB,EAAE;EACxE,IAAI;IACF,MAAMC,IAAI,GAAG,IAAAC,qDAAmC,EAACH,WAAW,EAAEC,WAAW,CAAC;IAC1E,IAAIC,IAAI,CAACE,YAAY,EAAE;MACrB,OAAOF,IAAI,CAACG,MAAM;IACpB;EACF,CAAC,CAAC,MAAM,CAAC;EACT,OAAO,KAAK;AACd;AAEO,SAASC,eAAe,CAACC,OAA2C,EAAY;EACrF,MAAMC,YAAY,GAAG,EAAE;EACvB,KAAK,MAAMH,MAAM,IAAIE,OAAO,EAAE;IAC5B,IAAI;MACF;MACA,MAAM,CAACE,MAAM,CAAC,GAAG,IAAAC,uCAAqB,EAACL,MAAM,CAAC;MAC9C,IAAI,OAAOI,MAAM,KAAK,QAAQ,EAAE;QAC9BD,YAAY,CAACG,IAAI,CAACF,MAAM,CAAC;MAC3B;IACF,CAAC,CAAC,MAAM;MACN;IAAA;EAEJ;EACA,OAAOD,YAAY;AACrB;AAEA,MAAMI,WAAW,GAAG,IAAAC,gCAAc,GAAE;AAE7B,eAAeC,yBAAyB,CAC7Cd,WAAmB,EACnBe,GAAgC,EAChCC,QAAkB,EAClB;EACAC,cAAG,CAACC,KAAK,CAAC,4BAA4B,CAAC;EAEvC,MAAMC,cAAc,GAAGJ,GAAG,CAACR,OAAO,IAAI,EAAE;EACxC,MAAMa,UAAU,GAAGd,eAAe,CAACa,cAAc,CAAC;EAElDF,cAAG,CAACC,KAAK,CAAE,qBAAoBE,UAAU,CAACC,IAAI,CAAC,IAAI,CAAE,EAAC,CAAC;EAEvD,MAAMd,OAAO,GAAGS,QAAQ,CAACM,MAAM,CAACC,GAAG,IAAI;IACrC,IAAIH,UAAU,CAACI,QAAQ,CAACD,GAAG,CAAC,EAAE;MAC5B;MACA,OAAO,KAAK;IACd;IACA;IACA,MAAMlB,MAAM,GAAGN,sBAAsB,CAACC,WAAW,EAAEuB,GAAG,CAAC;IAEvDN,cAAG,CAACC,KAAK,CACN,YAAWK,GAAI,iBAAgB,CAAC,CAAClB,MAAO,EAAC,IAAIA,MAAM,GAAI,WAAUA,MAAM,CAACoB,MAAO,GAAE,GAAG,EAAE,CAAC,CACzF;IAED,IAAIb,WAAW,CAACY,QAAQ,CAACD,GAAG,CAAC,EAAE;MAC7BN,cAAG,CAACC,KAAK,CAAE,YAAWK,GAAI,kCAAiC,CAAC;MAC5D,OAAO,KAAK;IACd;IAEA,OAAO,CAAC,CAAClB,MAAM;EACjB,CAAC,CAAC;EAEF,MAAM,IAAAqB,8CAAyB,EAAC1B,WAAW,EAAEe,GAAG,EAAER,OAAO,CAAC;AAC5D"}