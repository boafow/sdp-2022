{"version":3,"file":"bundledNativeModules.js","names":["getBundledNativeModulesAsync","projectRoot","sdkVersion","getBundledNativeModulesFromExpoPackageAsync","getBundledNativeModulesFromApiAsync","Log","warn","chalk","bold","client","ApiV2","clientForUser","list","getAsync","length","Error","fromBundledNativeModuleList","bundledNativeModulesPath","resolveFrom","silent","addNewLineIfNone","CommandError","JsonFile","readAsync","reduce","acc","i","npmPackage","versionRange"],"sources":["../../../src/commands/utils/bundledNativeModules.ts"],"sourcesContent":["import JsonFile from '@expo/json-file';\nimport chalk from 'chalk';\nimport resolveFrom from 'resolve-from';\nimport { ApiV2 } from 'xdl';\n\nimport CommandError from '../../CommandError';\nimport Log from '../../log';\n\ninterface NativeModule {\n  npmPackage: string;\n  versionRange: string;\n}\ntype BundledNativeModuleList = NativeModule[];\nexport type BundledNativeModules = Record<string, string>;\n\n/**\n * Gets the bundledNativeModules.json for a given SDK version:\n * - Tries to fetch the data from the /sdks/:sdkVersion/native-modules API endpoint.\n * - If the data is missing on the server (it can happen for SDKs that are yet fully released)\n *    or there's a downtime, reads the local .json file from the \"expo\" package.\n * - For UNVERSIONED, returns the local .json file contents.\n */\nexport async function getBundledNativeModulesAsync(\n  projectRoot: string,\n  sdkVersion: string\n): Promise<BundledNativeModules> {\n  if (sdkVersion === 'UNVERSIONED') {\n    return await getBundledNativeModulesFromExpoPackageAsync(projectRoot);\n  } else {\n    try {\n      return await getBundledNativeModulesFromApiAsync(sdkVersion);\n    } catch {\n      Log.warn(\n        `Unable to reach Expo servers. Falling back to using the cached dependency map (${chalk.bold(\n          'bundledNativeModules.json'\n        )}) from the package \"${chalk.bold`expo`}\" installed in your project.`\n      );\n      return await getBundledNativeModulesFromExpoPackageAsync(projectRoot);\n    }\n  }\n}\n\nasync function getBundledNativeModulesFromApiAsync(\n  sdkVersion: string\n): Promise<BundledNativeModules> {\n  const client = ApiV2.clientForUser();\n  /**\n   * The endpoint returns the list of bundled native modules for a given SDK version.\n   * The data is populated by the `et sync-bundled-native-modules` script from expo/expo repo.\n   * See the code for more details:\n   * https://github.com/expo/expo/blob/master/tools/src/commands/SyncBundledNativeModules.ts\n   *\n   * Example result:\n   * [\n   *   {\n   *     id: \"79285187-e5c4-47f7-b6a9-664f5d16f0db\",\n   *     sdkVersion: \"41.0.0\",\n   *     npmPackage: \"expo-analytics-amplitude\",\n   *     versionRange: \"~10.1.0\",\n   *     createdAt: \"2021-04-29T09:34:32.825Z\",\n   *     updatedAt: \"2021-04-29T09:34:32.825Z\"\n   *   },\n   *   ...\n   * ]\n   */\n  const list = await client.getAsync(`sdks/${sdkVersion}/native-modules`);\n  if (list.length === 0) {\n    throw new Error('The bundled native module list from www is empty');\n  }\n  return fromBundledNativeModuleList(list);\n}\n\n/**\n * Get the legacy static `bundledNativeModules.json` file\n * that's shipped with the version of `expo` that the project has installed.\n */\nasync function getBundledNativeModulesFromExpoPackageAsync(\n  projectRoot: string\n): Promise<BundledNativeModules> {\n  const bundledNativeModulesPath = resolveFrom.silent(\n    projectRoot,\n    'expo/bundledNativeModules.json'\n  );\n  if (!bundledNativeModulesPath) {\n    Log.addNewLineIfNone();\n    throw new CommandError(\n      `The dependency map ${chalk.bold(\n        `expo/bundledNativeModules.json`\n      )} cannot be found, please ensure you have the package \"${chalk.bold`expo`}\" installed in your project.\\n`\n    );\n  }\n  return await JsonFile.readAsync<BundledNativeModules>(bundledNativeModulesPath);\n}\n\nfunction fromBundledNativeModuleList(list: BundledNativeModuleList): BundledNativeModules {\n  return list.reduce((acc, i) => {\n    acc[i.npmPackage] = i.versionRange;\n    return acc;\n  }, {} as BundledNativeModules);\n}\n"],"mappings":";;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAA4B;AAS5B;AACA;AACA;AACA;AACA;AACA;AACA;AACO,eAAeA,4BAA4B,CAChDC,WAAmB,EACnBC,UAAkB,EACa;EAC/B,IAAIA,UAAU,KAAK,aAAa,EAAE;IAChC,OAAO,MAAMC,2CAA2C,CAACF,WAAW,CAAC;EACvE,CAAC,MAAM;IACL,IAAI;MACF,OAAO,MAAMG,mCAAmC,CAACF,UAAU,CAAC;IAC9D,CAAC,CAAC,MAAM;MACNG,cAAG,CAACC,IAAI,CACL,kFAAiFC,gBAAK,CAACC,IAAI,CAC1F,2BAA2B,CAC3B,uBAAsBD,gBAAK,CAACC,IAAK,MAAM,8BAA6B,CACvE;MACD,OAAO,MAAML,2CAA2C,CAACF,WAAW,CAAC;IACvE;EACF;AACF;AAEA,eAAeG,mCAAmC,CAChDF,UAAkB,EACa;EAC/B,MAAMO,MAAM,GAAGC,YAAK,CAACC,aAAa,EAAE;EACpC;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACE,MAAMC,IAAI,GAAG,MAAMH,MAAM,CAACI,QAAQ,CAAE,QAAOX,UAAW,iBAAgB,CAAC;EACvE,IAAIU,IAAI,CAACE,MAAM,KAAK,CAAC,EAAE;IACrB,MAAM,IAAIC,KAAK,CAAC,kDAAkD,CAAC;EACrE;EACA,OAAOC,2BAA2B,CAACJ,IAAI,CAAC;AAC1C;;AAEA;AACA;AACA;AACA;AACA,eAAeT,2CAA2C,CACxDF,WAAmB,EACY;EAC/B,MAAMgB,wBAAwB,GAAGC,sBAAW,CAACC,MAAM,CACjDlB,WAAW,EACX,gCAAgC,CACjC;EACD,IAAI,CAACgB,wBAAwB,EAAE;IAC7BZ,cAAG,CAACe,gBAAgB,EAAE;IACtB,MAAM,KAAIC,uBAAY,EACnB,sBAAqBd,gBAAK,CAACC,IAAI,CAC7B,gCAA+B,CAChC,yDAAwDD,gBAAK,CAACC,IAAK,MAAM,gCAA+B,CAC3G;EACH;EACA,OAAO,MAAMc,mBAAQ,CAACC,SAAS,CAAuBN,wBAAwB,CAAC;AACjF;AAEA,SAASD,2BAA2B,CAACJ,IAA6B,EAAwB;EACxF,OAAOA,IAAI,CAACY,MAAM,CAAC,CAACC,GAAG,EAAEC,CAAC,KAAK;IAC7BD,GAAG,CAACC,CAAC,CAACC,UAAU,CAAC,GAAGD,CAAC,CAACE,YAAY;IAClC,OAAOH,GAAG;EACZ,CAAC,EAAE,CAAC,CAAC,CAAyB;AAChC"}