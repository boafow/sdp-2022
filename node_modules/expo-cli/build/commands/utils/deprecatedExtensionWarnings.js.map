{"version":3,"file":"deprecatedExtensionWarnings.js","names":["queryExpoExtensionFilesAsync","projectRoot","ignore","results","wrapGlobWithTimeout","everyMatchAsync","absolute","cwd","Log","warn","assertProjectHasExpoExtensionFilesAsync","checkNodeModules","assertModulesHasExpoExtensionFilesAsync","time","matches","catch","timeEnd","length","promptMatchesAsync","getWorkspaceRoot","findWorkspaceRoot","error","message","includes","spinner","ora","start","root","filter","value","match","succeed","fail","logMatchedFiles","hasNodeModules","find","chalk","red","bold","reset","map","join","dim","program","nonInteractive","confirmAsync","initial","SilentError"],"sources":["../../../src/commands/utils/deprecatedExtensionWarnings.ts"],"sourcesContent":["import chalk from 'chalk';\nimport program from 'commander';\nimport findWorkspaceRoot from 'find-yarn-workspace-root';\n\nimport { SilentError } from '../../CommandError';\nimport Log from '../../log';\nimport { ora } from '../../utils/ora';\nimport { confirmAsync } from '../../utils/prompts';\nimport { everyMatchAsync, wrapGlobWithTimeout } from './glob';\n\nasync function queryExpoExtensionFilesAsync(\n  projectRoot: string,\n  ignore: string[]\n): Promise<string[]> {\n  const results = await wrapGlobWithTimeout(\n    () =>\n      everyMatchAsync('**/*.expo.@(js|jsx|ts|tsx)', {\n        absolute: true,\n        ignore,\n        cwd: projectRoot,\n      }),\n    5000\n  );\n\n  if (results === false) {\n    Log.warn('Failed to query all project files. Skipping `.expo.*` extension check...');\n    return [];\n  }\n  return results;\n}\n\nexport async function assertProjectHasExpoExtensionFilesAsync(\n  projectRoot: string,\n  checkNodeModules: boolean = false\n) {\n  if (checkNodeModules) {\n    await assertModulesHasExpoExtensionFilesAsync(projectRoot);\n  } else {\n    Log.time('assertProjectHasExpoExtensionFilesAsync');\n\n    const matches = await queryExpoExtensionFilesAsync(projectRoot, [\n      `**/@(Carthage|Pods|node_modules|ts-declarations|.expo)/**`,\n      '@(ios|android|web)/**',\n    ]).catch(() => [] as string[]);\n\n    Log.timeEnd('assertProjectHasExpoExtensionFilesAsync');\n    if (matches.length) {\n      await promptMatchesAsync(matches);\n    }\n  }\n}\n\n/** Wraps `findWorkspaceRoot` and guards against having an empty `package.json` file in an upper directory. */\nfunction getWorkspaceRoot(projectRoot: string): string | null {\n  try {\n    return findWorkspaceRoot(projectRoot);\n  } catch (error: any) {\n    if (error.message.includes('Unexpected end of JSON input')) {\n      return null;\n    }\n    throw error;\n  }\n}\n\nasync function assertModulesHasExpoExtensionFilesAsync(projectRoot: string) {\n  const spinner = ora('Checking project for deprecated features, this may take a moment.').start();\n  const root = getWorkspaceRoot(projectRoot) || projectRoot;\n\n  Log.time('assertModulesHasExpoExtensionFilesAsync');\n  let matches = await queryExpoExtensionFilesAsync(root, [\n    `**/@(Carthage|Pods|ts-declarations|.expo)/**`,\n    '@(ios|android|web)/**',\n  ]).catch(() => [] as string[]);\n  Log.timeEnd('assertModulesHasExpoExtensionFilesAsync');\n  matches = matches.filter(value => {\n    if (value.includes('node_modules')) {\n      // Remove duplicate files from packages compiled with bob\n      return !value.match(/node_modules\\/.*\\/lib\\/commonjs/g);\n    }\n    return true;\n  });\n\n  if (!matches.length) {\n    spinner.succeed('Validated project');\n    return;\n  } else {\n    spinner.fail('Found project files with deprecated features');\n  }\n\n  logMatchedFiles(matches);\n}\n\nfunction logMatchedFiles(matches: string[]) {\n  const hasNodeModules = matches.find(match => match.includes('node_modules/'));\n  Log.error(\n    chalk.red(\n      `Project is using deprecated ${chalk.bold`.expo.*`} file extensions.\\nPlease refactor the following files${\n        hasNodeModules ? ' and upgrade modules' : ''\n      } accordingly:\\n\\n`\n    ) +\n      chalk.reset(\n        matches.map(match => `- ${match}`).join('\\n') +\n          chalk.dim(\n            `\\n\\nDangerously disable this check with ${chalk.bold(\n              `EXPO_LEGACY_IMPORTS=1`\n            )}\\nLearn more: http://expo.fyi/expo-extension-migration\\n`\n          )\n      )\n  );\n}\n\nasync function promptMatchesAsync(matches: string[]) {\n  logMatchedFiles(matches);\n\n  // Skip in nonInteractive to give users a bypass\n  if (\n    program.nonInteractive ||\n    (await confirmAsync({ message: 'Would you like to continue anyways?', initial: true }))\n  ) {\n    return;\n  }\n\n  throw new SilentError();\n}\n"],"mappings":"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"}