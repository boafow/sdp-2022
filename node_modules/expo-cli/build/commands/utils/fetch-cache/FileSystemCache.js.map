{"version":3,"file":"FileSystemCache.js","names":["getBodyAndMetaKeys","key","FileSystemCache","constructor","options","get","metaKey","metaInfo","cacache","info","cacheDirectory","undefined","metaBuffer","byDigest","integrity","metaData","JSON","parse","bodyStreamIntegrity","empty","expiration","Date","now","bodyStream","Readable","from","Buffer","alloc","stream","remove","bodyKey","Promise","all","rm","entry","set","metaCopy","ttl","fulfill","reject","pipe","put","on","i","e","err","code","stringify","cachedData"],"sources":["../../../../src/commands/utils/fetch-cache/FileSystemCache.ts"],"sourcesContent":["import cacache from 'cacache';\nimport { Readable } from 'stream';\n\nfunction getBodyAndMetaKeys(key: string): [string, string] {\n  return [`${key}body`, `${key}meta`];\n}\n\nexport class FileSystemCache {\n  constructor(public options: { ttl?: boolean; cacheDirectory: string }) {}\n\n  async get(key: string) {\n    const [, metaKey] = getBodyAndMetaKeys(key);\n\n    const metaInfo = await cacache.get.info(this.options.cacheDirectory, metaKey);\n\n    if (!metaInfo) {\n      return undefined;\n    }\n\n    const metaBuffer = await cacache.get.byDigest(this.options.cacheDirectory, metaInfo.integrity);\n    const metaData = JSON.parse(metaBuffer);\n    const { bodyStreamIntegrity, empty, expiration } = metaData;\n\n    delete metaData.bodyStreamIntegrity;\n    delete metaData.empty;\n    delete metaData.expiration;\n\n    if (expiration && expiration < Date.now()) {\n      return undefined;\n    }\n\n    const bodyStream = empty\n      ? Readable.from(Buffer.alloc(0))\n      : cacache.get.stream.byDigest(this.options.cacheDirectory, bodyStreamIntegrity);\n\n    return {\n      bodyStream,\n      metaData,\n    };\n  }\n\n  remove(key: string) {\n    const [bodyKey, metaKey] = getBodyAndMetaKeys(key);\n\n    return Promise.all([\n      cacache.rm.entry(this.options.cacheDirectory, bodyKey),\n      cacache.rm.entry(this.options.cacheDirectory, metaKey),\n    ]);\n  }\n\n  async set(key: string, bodyStream: NodeJS.ReadStream, metaData: any) {\n    const [bodyKey, metaKey] = getBodyAndMetaKeys(key);\n    const metaCopy = { ...metaData };\n\n    if (typeof this.options.ttl === 'number') {\n      metaCopy.expiration = Date.now() + this.options.ttl;\n    }\n\n    try {\n      metaCopy.bodyStreamIntegrity = await new Promise((fulfill, reject) => {\n        bodyStream\n          .pipe(cacache.put.stream(this.options.cacheDirectory, bodyKey))\n          .on('integrity', i => fulfill(i))\n          .on('error', e => {\n            reject(e);\n          });\n      });\n    } catch (err: any) {\n      if (err.code !== 'ENODATA') {\n        throw err;\n      }\n\n      metaCopy.empty = true;\n    }\n\n    const metaBuffer = Buffer.from(JSON.stringify(metaCopy));\n    await cacache.put(this.options.cacheDirectory, metaKey, metaBuffer);\n    const cachedData = await this.get(key);\n\n    return cachedData;\n  }\n}\n"],"mappings":";;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAAkC;AAElC,SAASA,kBAAkB,CAACC,GAAW,EAAoB;EACzD,OAAO,CAAE,GAAEA,GAAI,MAAK,EAAG,GAAEA,GAAI,MAAK,CAAC;AACrC;AAEO,MAAMC,eAAe,CAAC;EAC3BC,WAAW,CAAQC,OAAkD,EAAE;IAAA,KAApDA,OAAkD,GAAlDA,OAAkD;EAAG;EAExE,MAAMC,GAAG,CAACJ,GAAW,EAAE;IACrB,MAAM,GAAGK,OAAO,CAAC,GAAGN,kBAAkB,CAACC,GAAG,CAAC;IAE3C,MAAMM,QAAQ,GAAG,MAAMC,kBAAO,CAACH,GAAG,CAACI,IAAI,CAAC,IAAI,CAACL,OAAO,CAACM,cAAc,EAAEJ,OAAO,CAAC;IAE7E,IAAI,CAACC,QAAQ,EAAE;MACb,OAAOI,SAAS;IAClB;IAEA,MAAMC,UAAU,GAAG,MAAMJ,kBAAO,CAACH,GAAG,CAACQ,QAAQ,CAAC,IAAI,CAACT,OAAO,CAACM,cAAc,EAAEH,QAAQ,CAACO,SAAS,CAAC;IAC9F,MAAMC,QAAQ,GAAGC,IAAI,CAACC,KAAK,CAACL,UAAU,CAAC;IACvC,MAAM;MAAEM,mBAAmB;MAAEC,KAAK;MAAEC;IAAW,CAAC,GAAGL,QAAQ;IAE3D,OAAOA,QAAQ,CAACG,mBAAmB;IACnC,OAAOH,QAAQ,CAACI,KAAK;IACrB,OAAOJ,QAAQ,CAACK,UAAU;IAE1B,IAAIA,UAAU,IAAIA,UAAU,GAAGC,IAAI,CAACC,GAAG,EAAE,EAAE;MACzC,OAAOX,SAAS;IAClB;IAEA,MAAMY,UAAU,GAAGJ,KAAK,GACpBK,kBAAQ,CAACC,IAAI,CAACC,MAAM,CAACC,KAAK,CAAC,CAAC,CAAC,CAAC,GAC9BnB,kBAAO,CAACH,GAAG,CAACuB,MAAM,CAACf,QAAQ,CAAC,IAAI,CAACT,OAAO,CAACM,cAAc,EAAEQ,mBAAmB,CAAC;IAEjF,OAAO;MACLK,UAAU;MACVR;IACF,CAAC;EACH;EAEAc,MAAM,CAAC5B,GAAW,EAAE;IAClB,MAAM,CAAC6B,OAAO,EAAExB,OAAO,CAAC,GAAGN,kBAAkB,CAACC,GAAG,CAAC;IAElD,OAAO8B,OAAO,CAACC,GAAG,CAAC,CACjBxB,kBAAO,CAACyB,EAAE,CAACC,KAAK,CAAC,IAAI,CAAC9B,OAAO,CAACM,cAAc,EAAEoB,OAAO,CAAC,EACtDtB,kBAAO,CAACyB,EAAE,CAACC,KAAK,CAAC,IAAI,CAAC9B,OAAO,CAACM,cAAc,EAAEJ,OAAO,CAAC,CACvD,CAAC;EACJ;EAEA,MAAM6B,GAAG,CAAClC,GAAW,EAAEsB,UAA6B,EAAER,QAAa,EAAE;IACnE,MAAM,CAACe,OAAO,EAAExB,OAAO,CAAC,GAAGN,kBAAkB,CAACC,GAAG,CAAC;IAClD,MAAMmC,QAAQ,GAAG;MAAE,GAAGrB;IAAS,CAAC;IAEhC,IAAI,OAAO,IAAI,CAACX,OAAO,CAACiC,GAAG,KAAK,QAAQ,EAAE;MACxCD,QAAQ,CAAChB,UAAU,GAAGC,IAAI,CAACC,GAAG,EAAE,GAAG,IAAI,CAAClB,OAAO,CAACiC,GAAG;IACrD;IAEA,IAAI;MACFD,QAAQ,CAAClB,mBAAmB,GAAG,MAAM,IAAIa,OAAO,CAAC,CAACO,OAAO,EAAEC,MAAM,KAAK;QACpEhB,UAAU,CACPiB,IAAI,CAAChC,kBAAO,CAACiC,GAAG,CAACb,MAAM,CAAC,IAAI,CAACxB,OAAO,CAACM,cAAc,EAAEoB,OAAO,CAAC,CAAC,CAC9DY,EAAE,CAAC,WAAW,EAAEC,CAAC,IAAIL,OAAO,CAACK,CAAC,CAAC,CAAC,CAChCD,EAAE,CAAC,OAAO,EAAEE,CAAC,IAAI;UAChBL,MAAM,CAACK,CAAC,CAAC;QACX,CAAC,CAAC;MACN,CAAC,CAAC;IACJ,CAAC,CAAC,OAAOC,GAAQ,EAAE;MACjB,IAAIA,GAAG,CAACC,IAAI,KAAK,SAAS,EAAE;QAC1B,MAAMD,GAAG;MACX;MAEAT,QAAQ,CAACjB,KAAK,GAAG,IAAI;IACvB;IAEA,MAAMP,UAAU,GAAGc,MAAM,CAACD,IAAI,CAACT,IAAI,CAAC+B,SAAS,CAACX,QAAQ,CAAC,CAAC;IACxD,MAAM5B,kBAAO,CAACiC,GAAG,CAAC,IAAI,CAACrC,OAAO,CAACM,cAAc,EAAEJ,OAAO,EAAEM,UAAU,CAAC;IACnE,MAAMoC,UAAU,GAAG,MAAM,IAAI,CAAC3C,GAAG,CAACJ,GAAG,CAAC;IAEtC,OAAO+C,UAAU;EACnB;AACF;AAAC"}