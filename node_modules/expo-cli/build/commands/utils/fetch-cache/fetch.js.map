{"version":3,"file":"fetch.js","names":["CACHE_VERSION","lockPromiseForKey","unlockFunctionForKey","lock","key","Promise","resolve","takeLockPromise","then","fulfill","unlock","md5","str","crypto","createHash","update","digest","getFormDataCacheKey","formData","cacheKey","boundary","getBoundary","_boundary","boundaryReplaceRegex","RegExp","_streams","map","s","replace","getBodyCacheKeyJson","body","URLSearchParams","toString","fs","ReadStream","path","Buffer","Error","getRequestCacheKey","req","cache","credentials","destination","headers","integrity","method","redirect","referrer","referrerPolicy","url","getCacheKey","requestArguments","resource","init","resourceCacheKeyJson","Request","initCacheKeyJson","agent","JSON","stringify","getResponse","cachedValue","get","ejectSelfFromCache","remove","NFCResponse","bodyStream","metaData","fetchResponse","fetch","serializedMeta","serializeMetaFromNodeFetchResponse","newlyCachedData","set","createFetchWithCache"],"sources":["../../../../src/commands/utils/fetch-cache/fetch.ts"],"sourcesContent":["/**\n * Copyright (c) 2021 Expo, Inc.\n * Copyright (c) 2020 mistval.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * Based on https://github.com/mistval/node-fetch-cache/blob/9c40ddf786b0de22ce521d8bdaa6347bc44dd629/src/index.js#L1\n * But with TypeScript support to fix Jest tests, and removed unused code.\n */\nimport crypto from 'crypto';\nimport FormData from 'form-data';\nimport fs from 'fs';\nimport fetch, { Request, RequestInfo, RequestInit, Response } from 'node-fetch';\nimport { URLSearchParams } from 'url';\n\nimport { NFCResponse } from './response';\n\nconst CACHE_VERSION = 3;\n\nconst lockPromiseForKey: Record<string, Promise<any>> = {};\nconst unlockFunctionForKey: Record<string, any> = {};\n\n/**\n * Take out a lock. When this function returns (asynchronously),\n * you have the lock.\n * @param {string} key - The key to lock on. Anyone else who\n *   tries to lock on the same key will need to wait for it to\n *   be unlocked.\n */\nasync function lock(key: string) {\n  if (!lockPromiseForKey[key]) {\n    lockPromiseForKey[key] = Promise.resolve();\n  }\n\n  const takeLockPromise = lockPromiseForKey[key];\n  lockPromiseForKey[key] = takeLockPromise.then(\n    () =>\n      new Promise(fulfill => {\n        unlockFunctionForKey[key] = fulfill;\n      })\n  );\n\n  return takeLockPromise;\n}\n\n/**\n * Release a lock.\n * @param {string} key - The key to release the lock for.\n *   The next person in line will now be able to take out\n *   the lock for that key.\n */\nfunction unlock(key: string) {\n  if (unlockFunctionForKey[key]) {\n    unlockFunctionForKey[key]();\n    delete unlockFunctionForKey[key];\n  }\n}\n\nfunction md5(str: string) {\n  return crypto.createHash('md5').update(str).digest('hex');\n}\n\n// Since the boundary in FormData is random,\n// we ignore it for purposes of calculating\n// the cache key.\nfunction getFormDataCacheKey(formData: FormData) {\n  const cacheKey = { ...formData };\n  const boundary = formData.getBoundary();\n\n  // @ts-expect-error\n  delete cacheKey._boundary;\n\n  const boundaryReplaceRegex = new RegExp(boundary, 'g');\n\n  // @ts-expect-error\n  cacheKey._streams = cacheKey._streams.map(s => {\n    if (typeof s === 'string') {\n      return s.replace(boundaryReplaceRegex, '');\n    }\n\n    return s;\n  });\n\n  return cacheKey;\n}\n\nfunction getBodyCacheKeyJson(body: any) {\n  if (!body) {\n    return body;\n  }\n  if (typeof body === 'string') {\n    return body;\n  }\n  if (body instanceof URLSearchParams) {\n    return body.toString();\n  }\n  if (body instanceof fs.ReadStream) {\n    return body.path;\n  }\n  if (body.toString && body.toString() === '[object FormData]') {\n    return getFormDataCacheKey(body);\n  }\n  if (body instanceof Buffer) {\n    return body.toString();\n  }\n\n  throw new Error(\n    'Unsupported body type. Supported body types are: string, number, undefined, null, url.URLSearchParams, fs.ReadStream, FormData'\n  );\n}\n\nfunction getRequestCacheKey(req: any) {\n  return {\n    cache: req.cache,\n    credentials: req.credentials,\n    destination: req.destination,\n    headers: req.headers,\n    integrity: req.integrity,\n    method: req.method,\n    redirect: req.redirect,\n    referrer: req.referrer,\n    referrerPolicy: req.referrerPolicy,\n    url: req.url,\n    body: getBodyCacheKeyJson(req.body),\n  };\n}\n\nfunction getCacheKey(requestArguments: any[]) {\n  const resource = requestArguments[0];\n  const init = requestArguments[1] || {};\n\n  const resourceCacheKeyJson =\n    resource instanceof Request ? getRequestCacheKey(resource) : { url: resource };\n\n  const initCacheKeyJson = { ...init };\n\n  // @ts-ignore\n  resourceCacheKeyJson.body = getBodyCacheKeyJson(resourceCacheKeyJson.body);\n  initCacheKeyJson.body = getBodyCacheKeyJson(initCacheKeyJson.body);\n\n  delete initCacheKeyJson.agent;\n\n  return md5(JSON.stringify([resourceCacheKeyJson, initCacheKeyJson, CACHE_VERSION]));\n}\n\nasync function getResponse(\n  cache: import('./FileSystemCache').FileSystemCache,\n  url: RequestInfo,\n  init?: RequestInit | undefined\n) {\n  const cacheKey = getCacheKey([url, init]);\n  let cachedValue = await cache.get(cacheKey);\n\n  const ejectSelfFromCache = () => cache.remove(cacheKey);\n\n  if (cachedValue) {\n    return new NFCResponse(cachedValue.bodyStream, cachedValue.metaData, ejectSelfFromCache, true);\n  }\n\n  await lock(cacheKey);\n  try {\n    cachedValue = await cache.get(cacheKey);\n    if (cachedValue) {\n      return new NFCResponse(\n        cachedValue.bodyStream,\n        cachedValue.metaData,\n        ejectSelfFromCache,\n        true\n      );\n    }\n\n    const fetchResponse = await fetch(url, init);\n    const serializedMeta = NFCResponse.serializeMetaFromNodeFetchResponse(fetchResponse);\n\n    const newlyCachedData = await cache.set(\n      cacheKey,\n      // @ts-expect-error\n      fetchResponse.body,\n      serializedMeta\n    );\n\n    return new NFCResponse(\n      newlyCachedData!.bodyStream,\n      newlyCachedData!.metaData,\n      ejectSelfFromCache,\n      false\n    );\n  } finally {\n    unlock(cacheKey);\n  }\n}\n\nfunction createFetchWithCache(\n  cache: import('./FileSystemCache').FileSystemCache\n): (url: RequestInfo, init?: RequestInit | undefined) => Promise<Response> {\n  return (url: RequestInfo, init?: RequestInit | undefined) => getResponse(cache, url, init);\n}\n\nexport default createFetchWithCache;\n"],"mappings":";;;;;;AAUA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAAyC;AAAA;AAAA;AAhBzC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AASA,MAAMA,aAAa,GAAG,CAAC;AAEvB,MAAMC,iBAA+C,GAAG,CAAC,CAAC;AAC1D,MAAMC,oBAAyC,GAAG,CAAC,CAAC;;AAEpD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,eAAeC,IAAI,CAACC,GAAW,EAAE;EAC/B,IAAI,CAACH,iBAAiB,CAACG,GAAG,CAAC,EAAE;IAC3BH,iBAAiB,CAACG,GAAG,CAAC,GAAGC,OAAO,CAACC,OAAO,EAAE;EAC5C;EAEA,MAAMC,eAAe,GAAGN,iBAAiB,CAACG,GAAG,CAAC;EAC9CH,iBAAiB,CAACG,GAAG,CAAC,GAAGG,eAAe,CAACC,IAAI,CAC3C,MACE,IAAIH,OAAO,CAACI,OAAO,IAAI;IACrBP,oBAAoB,CAACE,GAAG,CAAC,GAAGK,OAAO;EACrC,CAAC,CAAC,CACL;EAED,OAAOF,eAAe;AACxB;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,SAASG,MAAM,CAACN,GAAW,EAAE;EAC3B,IAAIF,oBAAoB,CAACE,GAAG,CAAC,EAAE;IAC7BF,oBAAoB,CAACE,GAAG,CAAC,EAAE;IAC3B,OAAOF,oBAAoB,CAACE,GAAG,CAAC;EAClC;AACF;AAEA,SAASO,GAAG,CAACC,GAAW,EAAE;EACxB,OAAOC,iBAAM,CAACC,UAAU,CAAC,KAAK,CAAC,CAACC,MAAM,CAACH,GAAG,CAAC,CAACI,MAAM,CAAC,KAAK,CAAC;AAC3D;;AAEA;AACA;AACA;AACA,SAASC,mBAAmB,CAACC,QAAkB,EAAE;EAC/C,MAAMC,QAAQ,GAAG;IAAE,GAAGD;EAAS,CAAC;EAChC,MAAME,QAAQ,GAAGF,QAAQ,CAACG,WAAW,EAAE;;EAEvC;EACA,OAAOF,QAAQ,CAACG,SAAS;EAEzB,MAAMC,oBAAoB,GAAG,IAAIC,MAAM,CAACJ,QAAQ,EAAE,GAAG,CAAC;;EAEtD;EACAD,QAAQ,CAACM,QAAQ,GAAGN,QAAQ,CAACM,QAAQ,CAACC,GAAG,CAACC,CAAC,IAAI;IAC7C,IAAI,OAAOA,CAAC,KAAK,QAAQ,EAAE;MACzB,OAAOA,CAAC,CAACC,OAAO,CAACL,oBAAoB,EAAE,EAAE,CAAC;IAC5C;IAEA,OAAOI,CAAC;EACV,CAAC,CAAC;EAEF,OAAOR,QAAQ;AACjB;AAEA,SAASU,mBAAmB,CAACC,IAAS,EAAE;EACtC,IAAI,CAACA,IAAI,EAAE;IACT,OAAOA,IAAI;EACb;EACA,IAAI,OAAOA,IAAI,KAAK,QAAQ,EAAE;IAC5B,OAAOA,IAAI;EACb;EACA,IAAIA,IAAI,YAAYC,sBAAe,EAAE;IACnC,OAAOD,IAAI,CAACE,QAAQ,EAAE;EACxB;EACA,IAAIF,IAAI,YAAYG,aAAE,CAACC,UAAU,EAAE;IACjC,OAAOJ,IAAI,CAACK,IAAI;EAClB;EACA,IAAIL,IAAI,CAACE,QAAQ,IAAIF,IAAI,CAACE,QAAQ,EAAE,KAAK,mBAAmB,EAAE;IAC5D,OAAOf,mBAAmB,CAACa,IAAI,CAAC;EAClC;EACA,IAAIA,IAAI,YAAYM,MAAM,EAAE;IAC1B,OAAON,IAAI,CAACE,QAAQ,EAAE;EACxB;EAEA,MAAM,IAAIK,KAAK,CACb,gIAAgI,CACjI;AACH;AAEA,SAASC,kBAAkB,CAACC,GAAQ,EAAE;EACpC,OAAO;IACLC,KAAK,EAAED,GAAG,CAACC,KAAK;IAChBC,WAAW,EAAEF,GAAG,CAACE,WAAW;IAC5BC,WAAW,EAAEH,GAAG,CAACG,WAAW;IAC5BC,OAAO,EAAEJ,GAAG,CAACI,OAAO;IACpBC,SAAS,EAAEL,GAAG,CAACK,SAAS;IACxBC,MAAM,EAAEN,GAAG,CAACM,MAAM;IAClBC,QAAQ,EAAEP,GAAG,CAACO,QAAQ;IACtBC,QAAQ,EAAER,GAAG,CAACQ,QAAQ;IACtBC,cAAc,EAAET,GAAG,CAACS,cAAc;IAClCC,GAAG,EAAEV,GAAG,CAACU,GAAG;IACZnB,IAAI,EAAED,mBAAmB,CAACU,GAAG,CAACT,IAAI;EACpC,CAAC;AACH;AAEA,SAASoB,WAAW,CAACC,gBAAuB,EAAE;EAC5C,MAAMC,QAAQ,GAAGD,gBAAgB,CAAC,CAAC,CAAC;EACpC,MAAME,IAAI,GAAGF,gBAAgB,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;EAEtC,MAAMG,oBAAoB,GACxBF,QAAQ,YAAYG,oBAAO,GAAGjB,kBAAkB,CAACc,QAAQ,CAAC,GAAG;IAAEH,GAAG,EAAEG;EAAS,CAAC;EAEhF,MAAMI,gBAAgB,GAAG;IAAE,GAAGH;EAAK,CAAC;;EAEpC;EACAC,oBAAoB,CAACxB,IAAI,GAAGD,mBAAmB,CAACyB,oBAAoB,CAACxB,IAAI,CAAC;EAC1E0B,gBAAgB,CAAC1B,IAAI,GAAGD,mBAAmB,CAAC2B,gBAAgB,CAAC1B,IAAI,CAAC;EAElE,OAAO0B,gBAAgB,CAACC,KAAK;EAE7B,OAAO9C,GAAG,CAAC+C,IAAI,CAACC,SAAS,CAAC,CAACL,oBAAoB,EAAEE,gBAAgB,EAAExD,aAAa,CAAC,CAAC,CAAC;AACrF;AAEA,eAAe4D,WAAW,CACxBpB,KAAkD,EAClDS,GAAgB,EAChBI,IAA8B,EAC9B;EACA,MAAMlC,QAAQ,GAAG+B,WAAW,CAAC,CAACD,GAAG,EAAEI,IAAI,CAAC,CAAC;EACzC,IAAIQ,WAAW,GAAG,MAAMrB,KAAK,CAACsB,GAAG,CAAC3C,QAAQ,CAAC;EAE3C,MAAM4C,kBAAkB,GAAG,MAAMvB,KAAK,CAACwB,MAAM,CAAC7C,QAAQ,CAAC;EAEvD,IAAI0C,WAAW,EAAE;IACf,OAAO,KAAII,uBAAW,EAACJ,WAAW,CAACK,UAAU,EAAEL,WAAW,CAACM,QAAQ,EAAEJ,kBAAkB,EAAE,IAAI,CAAC;EAChG;EAEA,MAAM5D,IAAI,CAACgB,QAAQ,CAAC;EACpB,IAAI;IACF0C,WAAW,GAAG,MAAMrB,KAAK,CAACsB,GAAG,CAAC3C,QAAQ,CAAC;IACvC,IAAI0C,WAAW,EAAE;MACf,OAAO,KAAII,uBAAW,EACpBJ,WAAW,CAACK,UAAU,EACtBL,WAAW,CAACM,QAAQ,EACpBJ,kBAAkB,EAClB,IAAI,CACL;IACH;IAEA,MAAMK,aAAa,GAAG,MAAM,IAAAC,oBAAK,EAACpB,GAAG,EAAEI,IAAI,CAAC;IAC5C,MAAMiB,cAAc,GAAGL,uBAAW,CAACM,kCAAkC,CAACH,aAAa,CAAC;IAEpF,MAAMI,eAAe,GAAG,MAAMhC,KAAK,CAACiC,GAAG,CACrCtD,QAAQ;IACR;IACAiD,aAAa,CAACtC,IAAI,EAClBwC,cAAc,CACf;IAED,OAAO,KAAIL,uBAAW,EACpBO,eAAe,CAAEN,UAAU,EAC3BM,eAAe,CAAEL,QAAQ,EACzBJ,kBAAkB,EAClB,KAAK,CACN;EACH,CAAC,SAAS;IACRrD,MAAM,CAACS,QAAQ,CAAC;EAClB;AACF;AAEA,SAASuD,oBAAoB,CAC3BlC,KAAkD,EACuB;EACzE,OAAO,CAACS,GAAgB,EAAEI,IAA8B,KAAKO,WAAW,CAACpB,KAAK,EAAES,GAAG,EAAEI,IAAI,CAAC;AAC5F;AAAC,eAEcqB,oBAAoB;AAAA"}