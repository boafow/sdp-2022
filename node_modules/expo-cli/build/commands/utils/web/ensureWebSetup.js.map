{"version":3,"file":"ensureWebSetup.js","names":["WEB_FEATURE_FLAG","hasChecked","disabledReason","ensureWebSupportSetupAsync","projectRoot","skipCache","Log","log","chalk","dim","result","shouldSetupWebSupportAsync","failureReason","ensureWebDependenciesInstalledAsync","exp","isWebPlatformExcluded","rootConfig","isWebExcluded","Array","isArray","expo","platforms","length","includes","boolish","projectConfig","getConfig","skipSDKVersionRequirement","configName","getProjectConfigDescriptionWithPaths","bold","requiredPackages","file","pkg","skipPrompt","program","nonInteractive","missing","getMissingPackagesAsync","readableMissingPackages","map","p","join","isYarn","PackageManager","isUsingYarn","title","Prompts","pauseInteractions","confirm","confirmAsync","message","wrapForTerminal","cyan","initial","resumeInteractions","packages","version","installPackagesAsync","installCommand","createInstallCommand","disableMessage","solution","reset","CommandError","wrapAnsi","process","stdout","columns","packageManager","createForProject","yarn","silent","isDebug","packagesStr","newLine","installingPackageStep","logNewSection","addAsync","e","fail","succeed"],"sources":["../../../../src/commands/utils/web/ensureWebSetup.ts"],"sourcesContent":["import {\n  AppJSONConfig,\n  ExpoConfig,\n  getConfig,\n  getProjectConfigDescriptionWithPaths,\n  ProjectConfig,\n} from '@expo/config';\nimport * as PackageManager from '@expo/package-manager';\nimport chalk from 'chalk';\nimport program from 'commander';\nimport { boolish } from 'getenv';\nimport wrapAnsi from 'wrap-ansi';\nimport { Prompts } from 'xdl';\n\nimport CommandError from '../../../CommandError';\nimport Log from '../../../log';\nimport { logNewSection } from '../../../utils/ora';\nimport { confirmAsync } from '../../../utils/prompts';\nimport { getMissingPackagesAsync } from './getMissingPackages';\n\nconst WEB_FEATURE_FLAG = 'EXPO_NO_WEB_SETUP';\n\n// Only check once per run.\nlet hasChecked = false;\nlet disabledReason = '';\n\nexport async function ensureWebSupportSetupAsync(\n  projectRoot: string,\n  { skipCache = false }: { skipCache?: boolean } = {}\n): Promise<boolean> {\n  if (!skipCache && hasChecked) {\n    if (disabledReason) {\n      Log.log(chalk.dim(disabledReason));\n    }\n    return false;\n  }\n  hasChecked = true;\n\n  const result = await shouldSetupWebSupportAsync(projectRoot);\n\n  if ('failureReason' in result) {\n    disabledReason = result.failureReason;\n    return ensureWebSupportSetupAsync(projectRoot);\n  }\n\n  // Ensure web packages are installed\n  await ensureWebDependenciesInstalledAsync(projectRoot, { exp: result.exp });\n\n  return true;\n}\n\nexport function isWebPlatformExcluded(rootConfig: AppJSONConfig): boolean {\n  // Detect if the 'web' string is purposefully missing from the platforms array.\n  const isWebExcluded =\n    Array.isArray(rootConfig.expo?.platforms) &&\n    !!rootConfig.expo?.platforms.length &&\n    !rootConfig.expo?.platforms.includes('web');\n  return isWebExcluded;\n}\n\nexport async function shouldSetupWebSupportAsync(\n  projectRoot: string\n): Promise<{ failureReason: string } | ProjectConfig> {\n  if (boolish(WEB_FEATURE_FLAG, false)) {\n    return { failureReason: '\\u203A Skipping web setup: EXPO_NO_WEB_SETUP is enabled.' };\n  }\n\n  const projectConfig = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n\n  // Detect if the 'web' string is purposefully missing from the platforms array.\n  if (isWebPlatformExcluded(projectConfig.rootConfig)) {\n    // Get exact config description with paths.\n    const configName = getProjectConfigDescriptionWithPaths(projectRoot, projectConfig);\n    return {\n      failureReason: `\\u203A Skipping web setup: ${chalk.bold`\"web\"`} is not included in the project ${configName} ${chalk.bold`\"platforms\"`} array.`,\n    };\n  }\n\n  return projectConfig;\n}\n\nconst requiredPackages = [\n  // use react-native-web/package.json to skip node module cache issues when the user installs\n  // the package and attempts to resolve the module in the same process.\n  { file: 'react-native-web/package.json', pkg: 'react-native-web' },\n  { file: 'react-dom/package.json', pkg: 'react-dom' },\n];\n\nasync function ensureWebDependenciesInstalledAsync(\n  projectRoot: string,\n  {\n    exp = getConfig(projectRoot, { skipSDKVersionRequirement: true }).exp,\n    // Don't prompt in CI\n    skipPrompt = program.nonInteractive,\n  }: {\n    exp?: ExpoConfig;\n    skipPrompt?: boolean;\n  } = {}\n): Promise<boolean> {\n  const { missing } = await getMissingPackagesAsync(projectRoot, { exp, requiredPackages });\n  if (!missing.length) {\n    return true;\n  }\n\n  // Prompt to install or bail out...\n  const readableMissingPackages = missing.map(p => p.pkg).join(', ');\n\n  const isYarn = PackageManager.isUsingYarn(projectRoot);\n\n  let title = `It looks like you're trying to use web support but don't have the required dependencies installed.`;\n\n  if (skipPrompt) {\n    title += '\\n\\n';\n  } else {\n    Prompts.pauseInteractions();\n    let confirm: boolean;\n    try {\n      confirm = await confirmAsync({\n        message: wrapForTerminal(\n          title + ` Would you like to install ${chalk.cyan(readableMissingPackages)}?`\n        ),\n        initial: true,\n      });\n    } finally {\n      Prompts.resumeInteractions();\n    }\n\n    if (confirm) {\n      // Format with version if available.\n      const packages = missing.map(({ pkg, version }) =>\n        version ? [pkg, version].join('@') : pkg\n      );\n      // Install packages with versions\n      await installPackagesAsync(projectRoot, {\n        isYarn,\n        packages,\n      });\n      // Try again but skip prompting twice, simply fail if the packages didn't install correctly.\n      return await ensureWebDependenciesInstalledAsync(projectRoot, {\n        skipPrompt: true,\n      });\n    }\n\n    // Reset the title so it doesn't print twice in interactive mode.\n    title = '';\n  }\n\n  const installCommand = createInstallCommand({ isYarn, packages: missing });\n\n  const disableMessage = `If you're not using web, please remove the ${chalk.bold(\n    '\"web\"'\n  )} string from the platforms array in the project Expo config.`;\n\n  const solution = `Please install ${chalk.bold(\n    readableMissingPackages\n  )} by running:\\n\\n  ${chalk.reset.bold(installCommand)}\\n\\n`;\n\n  // Reset the cached check so we can re-run the check if the user re-runs the command.\n  hasChecked = false;\n  // This prevents users from starting a misconfigured JS or TS project by default.\n  throw new CommandError(wrapForTerminal(title + solution + disableMessage + '\\n'));\n}\n\n// Wrap long messages to fit smaller terminals.\nfunction wrapForTerminal(message: string): string {\n  return wrapAnsi(message, process.stdout.columns || 80);\n}\n\nexport function createInstallCommand({\n  isYarn,\n  packages,\n}: {\n  isYarn: boolean;\n  packages: {\n    file: string;\n    pkg: string;\n    version?: string | undefined;\n  }[];\n}) {\n  return (\n    (isYarn ? 'yarn add' : 'npm install') +\n    ' ' +\n    packages\n      .map(({ pkg, version }) => {\n        if (version) {\n          return [pkg, version].join('@');\n        }\n        return pkg;\n      })\n      .join(' ')\n  );\n}\n\nasync function installPackagesAsync(\n  projectRoot: string,\n  { isYarn, packages }: { isYarn: boolean; packages: string[] }\n) {\n  const packageManager = PackageManager.createForProject(projectRoot, {\n    yarn: isYarn,\n    log: Log.log,\n    silent: !Log.isDebug,\n  });\n\n  const packagesStr = chalk.bold(packages.join(', '));\n  Log.newLine();\n  const installingPackageStep = logNewSection(`Installing ${packagesStr}`);\n  try {\n    await packageManager.addAsync(...packages);\n  } catch (e: any) {\n    installingPackageStep.fail(`Failed to install ${packagesStr} with error: ${e.message}`);\n    throw e;\n  }\n  installingPackageStep.succeed(`Installed ${packagesStr}`);\n}\n"],"mappings":"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"}