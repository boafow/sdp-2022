{"version":3,"file":"utils.js","names":["SECRET_MIN_LENGTH","SECRET_MAX_LENGTH","validateSecret","secret","assert","length","generateSecret","randomSecret","crypto","randomBytes","toString","Log","log","chalk","underline","setupAsync","projectRoot","exp","getConfig","skipSDKVersionRequirement","slug","CommandError","ErrorCodes","MISSING_SLUG","findConfigFile","configName","user","UserManager","ensureLoggedInAsync","client","ApiV2","clientForUser","experienceName","owner","username","projects","getAsync","projectNotFoundError","project","error","code","PROJECT_NOT_FOUND"],"sources":["../../../src/commands/webhooks/utils.ts"],"sourcesContent":["import { findConfigFile, getConfig } from '@expo/config';\nimport assert from 'assert';\nimport chalk from 'chalk';\nimport crypto from 'crypto';\nimport { ApiV2, UserManager } from 'xdl';\n\nimport CommandError, { ErrorCodes } from '../../CommandError';\nimport Log from '../../log';\n\nconst SECRET_MIN_LENGTH = 16;\nconst SECRET_MAX_LENGTH = 1000;\n\nexport type WebhookEvent = 'build';\n\nexport function validateSecret({ secret }: { secret?: string }): string | null {\n  if (secret) {\n    assert(\n      secret.length >= SECRET_MIN_LENGTH && secret.length < SECRET_MAX_LENGTH,\n      `--secret: should be ${SECRET_MIN_LENGTH}-${SECRET_MAX_LENGTH} characters long`\n    );\n    return secret;\n  }\n  return null;\n}\n\nexport function generateSecret() {\n  // Create a 60 characters long secret from 30 random bytes.\n  const randomSecret = crypto.randomBytes(30).toString('hex');\n  Log.log(chalk.underline('Webhook signing secret:'));\n  Log.log(randomSecret);\n  return randomSecret;\n}\n\nexport async function setupAsync(projectRoot: string) {\n  const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n  const { slug } = exp;\n  if (!slug) {\n    throw new CommandError(\n      ErrorCodes.MISSING_SLUG,\n      `expo.slug is not defined in ${findConfigFile(projectRoot).configName}`\n    );\n  }\n  const user = await UserManager.ensureLoggedInAsync();\n  const client = ApiV2.clientForUser(user);\n  const experienceName = `@${exp.owner ?? user.username}/${exp.slug}`;\n  try {\n    const projects = await client.getAsync('projects', {\n      experienceName,\n    });\n    if (projects.length === 0) {\n      throw projectNotFoundError(experienceName);\n    }\n    const project = projects[0];\n    return { experienceName, project, client };\n  } catch (error: any) {\n    if (error.code === 'EXPERIENCE_NOT_FOUND') {\n      throw projectNotFoundError(experienceName);\n    } else {\n      throw error;\n    }\n  }\n}\n\nfunction projectNotFoundError(experienceName: string) {\n  return new CommandError(\n    ErrorCodes.PROJECT_NOT_FOUND,\n    `Project ${experienceName} not found. The project is created the first time you run \\`expo publish\\` or build the project (https://docs.expo.dev/distribution/building-standalone-apps/).`\n  );\n}\n"],"mappings":";;;;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAA4B;AAAA;AAAA;AAE5B,MAAMA,iBAAiB,GAAG,EAAE;AAC5B,MAAMC,iBAAiB,GAAG,IAAI;AAIvB,SAASC,cAAc,CAAC;EAAEC;AAA4B,CAAC,EAAiB;EAC7E,IAAIA,MAAM,EAAE;IACV,IAAAC,iBAAM,EACJD,MAAM,CAACE,MAAM,IAAIL,iBAAiB,IAAIG,MAAM,CAACE,MAAM,GAAGJ,iBAAiB,EACtE,uBAAsBD,iBAAkB,IAAGC,iBAAkB,kBAAiB,CAChF;IACD,OAAOE,MAAM;EACf;EACA,OAAO,IAAI;AACb;AAEO,SAASG,cAAc,GAAG;EAC/B;EACA,MAAMC,YAAY,GAAGC,iBAAM,CAACC,WAAW,CAAC,EAAE,CAAC,CAACC,QAAQ,CAAC,KAAK,CAAC;EAC3DC,cAAG,CAACC,GAAG,CAACC,gBAAK,CAACC,SAAS,CAAC,yBAAyB,CAAC,CAAC;EACnDH,cAAG,CAACC,GAAG,CAACL,YAAY,CAAC;EACrB,OAAOA,YAAY;AACrB;AAEO,eAAeQ,UAAU,CAACC,WAAmB,EAAE;EAAA;EACpD,MAAM;IAAEC;EAAI,CAAC,GAAG,IAAAC,mBAAS,EAACF,WAAW,EAAE;IAAEG,yBAAyB,EAAE;EAAK,CAAC,CAAC;EAC3E,MAAM;IAAEC;EAAK,CAAC,GAAGH,GAAG;EACpB,IAAI,CAACG,IAAI,EAAE;IACT,MAAM,KAAIC,uBAAY,EACpBC,0BAAU,CAACC,YAAY,EACtB,+BAA8B,IAAAC,wBAAc,EAACR,WAAW,CAAC,CAACS,UAAW,EAAC,CACxE;EACH;EACA,MAAMC,IAAI,GAAG,MAAMC,kBAAW,CAACC,mBAAmB,EAAE;EACpD,MAAMC,MAAM,GAAGC,YAAK,CAACC,aAAa,CAACL,IAAI,CAAC;EACxC,MAAMM,cAAc,GAAI,IAAC,cAAEf,GAAG,CAACgB,KAAK,mDAAIP,IAAI,CAACQ,QAAS,IAAGjB,GAAG,CAACG,IAAK,EAAC;EACnE,IAAI;IACF,MAAMe,QAAQ,GAAG,MAAMN,MAAM,CAACO,QAAQ,CAAC,UAAU,EAAE;MACjDJ;IACF,CAAC,CAAC;IACF,IAAIG,QAAQ,CAAC9B,MAAM,KAAK,CAAC,EAAE;MACzB,MAAMgC,oBAAoB,CAACL,cAAc,CAAC;IAC5C;IACA,MAAMM,OAAO,GAAGH,QAAQ,CAAC,CAAC,CAAC;IAC3B,OAAO;MAAEH,cAAc;MAAEM,OAAO;MAAET;IAAO,CAAC;EAC5C,CAAC,CAAC,OAAOU,KAAU,EAAE;IACnB,IAAIA,KAAK,CAACC,IAAI,KAAK,sBAAsB,EAAE;MACzC,MAAMH,oBAAoB,CAACL,cAAc,CAAC;IAC5C,CAAC,MAAM;MACL,MAAMO,KAAK;IACb;EACF;AACF;AAEA,SAASF,oBAAoB,CAACL,cAAsB,EAAE;EACpD,OAAO,KAAIX,uBAAY,EACrBC,0BAAU,CAACmB,iBAAiB,EAC3B,WAAUT,cAAe,iKAAgK,CAC3L;AACH"}