{"version":3,"file":"context.js","names":["Context","nonInteractive","_nonInteractive","user","_user","hasProjectContext","_hasProjectContext","projectDir","_projectDir","projectOwner","UserManager","getProjectOwner","manifest","_manifest","Error","api","_apiClient","android","_androidApiClient","ios","_iosApiClient","appleCtx","_appleCtx","value","hasAppleCtx","ensureAppleCtx","authenticateAsync","_appleCtxOptions","logOwnerAndProject","isProxyUser","owner","username","Log","log","slug","init","options","allowAnonymous","appleId","appleIdPassword","teamId","getCurrentUserAsync","undefined","ensureLoggedInAsync","ApiV2","clientForUser","IosApi","AndroidApi","exp","getConfig","skipSDKVersionRequirement"],"sources":["../../src/credentials/context.ts"],"sourcesContent":["import { ExpoConfig, getConfig } from '@expo/config';\nimport { ApiV2, RobotUser, User, UserManager } from 'xdl';\n\nimport { AppleCtx, authenticateAsync } from '../appleApi';\nimport Log from '../log';\nimport AndroidApi from './api/AndroidApi';\nimport IosApi from './api/IosApi';\n\nexport interface IView {\n  open(ctx: Context): Promise<IView | null>;\n}\n\ninterface AppleCtxOptions {\n  appleId?: string;\n  appleIdPassword?: string;\n  teamId?: string;\n}\n\ninterface CtxOptions extends AppleCtxOptions {\n  allowAnonymous?: boolean;\n  nonInteractive?: boolean;\n}\n\nexport class Context {\n  _hasProjectContext: boolean = false;\n  _projectDir?: string;\n  _user?: User | RobotUser;\n  _manifest?: ExpoConfig;\n  _apiClient?: ApiV2;\n  _iosApiClient?: IosApi;\n  _androidApiClient?: AndroidApi;\n  _appleCtxOptions?: AppleCtxOptions;\n  _appleCtx?: AppleCtx;\n  _nonInteractive?: boolean;\n\n  get nonInteractive(): boolean {\n    return this._nonInteractive === true;\n  }\n\n  get user(): User | RobotUser {\n    return this._user as User | RobotUser;\n  }\n  get hasProjectContext(): boolean {\n    return this._hasProjectContext;\n  }\n  get projectDir(): string {\n    return this._projectDir as string;\n  }\n  get projectOwner(): string {\n    return UserManager.getProjectOwner(this.user, this.manifest);\n  }\n  get manifest(): ExpoConfig {\n    if (!this._manifest) {\n      throw new Error('Manifest (app.json) not initialized.');\n    }\n    return this._manifest;\n  }\n  get api(): ApiV2 {\n    return this._apiClient as ApiV2;\n  }\n  get android(): AndroidApi {\n    return this._androidApiClient as AndroidApi;\n  }\n  get ios(): IosApi {\n    return this._iosApiClient as IosApi;\n  }\n  get appleCtx(): AppleCtx {\n    if (!this._appleCtx) {\n      throw new Error('Apple context not initialized.');\n    }\n    return this._appleCtx;\n  }\n  set manifest(value: ExpoConfig) {\n    this._manifest = value;\n  }\n\n  hasAppleCtx(): boolean {\n    return !!this._appleCtx;\n  }\n\n  async ensureAppleCtx() {\n    if (!this._appleCtx) {\n      this._appleCtx = await authenticateAsync(this._appleCtxOptions);\n    }\n  }\n\n  logOwnerAndProject() {\n    // Figure out if User A is configuring credentials as admin for User B's project\n    const isProxyUser = this.manifest.owner && this.manifest.owner !== this.user.username;\n    Log.log(\n      `Accessing credentials ${isProxyUser ? 'on behalf of' : 'for'} ${\n        this.projectOwner\n      } in project ${this.manifest.slug}`\n    );\n  }\n\n  async init(projectDir: string, options: CtxOptions = {}) {\n    const { allowAnonymous, appleId, appleIdPassword, teamId, nonInteractive } = options;\n    this._user = (await UserManager.getCurrentUserAsync()) || undefined;\n\n    // User isn't signed it, but needs to be signed in\n    if (!this._user && !allowAnonymous) {\n      this._user = (await UserManager.ensureLoggedInAsync()) as User;\n    }\n\n    this._projectDir = projectDir;\n    this._apiClient = ApiV2.clientForUser(this.user);\n    this._iosApiClient = new IosApi(this.api);\n    this._androidApiClient = new AndroidApi(this.api);\n    this._appleCtxOptions = { appleId, appleIdPassword, teamId };\n    this._nonInteractive = nonInteractive;\n\n    // try to access project context\n    try {\n      const { exp } = getConfig(projectDir, { skipSDKVersionRequirement: true });\n      this._manifest = exp;\n      this._hasProjectContext = true;\n      this.logOwnerAndProject();\n    } catch {\n      // ignore error\n      // startcredentials manager without project context\n    }\n  }\n}\n"],"mappings":"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"}