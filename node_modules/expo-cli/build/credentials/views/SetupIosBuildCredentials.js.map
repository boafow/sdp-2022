{"version":3,"file":"SetupIosBuildCredentials.js","names":["SetupIosBuildCredentials","constructor","app","open","ctx","bestEffortAppleCtx","hasAppleCtx","appleApi","ensureBundleIdExistsAsync","appleCtx","enablePushNotifications","runCredentialsManager","SetupIosDist","error","Log","distCert","ios","getDistCert","CommandError","SetupIosProvisioningProfile","nonInteractive","confirm","confirmAsync","message","ensureAppleCtx","log","chalk","green","SetupIosBuildCredentialsFromLocal","localCredentials","credentialsJsonReader","readIosCredentialsAsync","projectDir","team","readAppleTeam","provisioningProfile","updateProvisioningProfile","credentials","getAllCredentials","accountName","appsUsingCert","id","appCredentials","filter","cred","distCredentialsId","appInfo","projectName","bundleIdentifier","newDistCert","certP12","distributionCertificate","certPassword","length","update","prompts","type","name","choices","title","value","updateDistCert","createdDistCert","createDistCert","useDistCert"],"sources":["../../../src/credentials/views/SetupIosBuildCredentials.ts"],"sourcesContent":["import chalk from 'chalk';\n\nimport CommandError from '../../CommandError';\nimport * as appleApi from '../../appleApi';\nimport Log from '../../log';\nimport prompts, { confirmAsync } from '../../utils/prompts';\nimport { AppLookupParams } from '../api/IosApi';\nimport { Context, IView } from '../context';\nimport * as credentialsJsonReader from '../credentialsJson/read';\nimport { runCredentialsManager } from '../route';\nimport { readAppleTeam } from '../utils/provisioningProfile';\nimport { SetupIosDist } from './SetupIosDist';\nimport { SetupIosProvisioningProfile } from './SetupIosProvisioningProfile';\n\nexport class SetupIosBuildCredentials implements IView {\n  constructor(private app: AppLookupParams) {}\n\n  async open(ctx: Context): Promise<IView | null> {\n    await this.bestEffortAppleCtx(ctx);\n\n    if (ctx.hasAppleCtx()) {\n      await appleApi.ensureBundleIdExistsAsync(ctx.appleCtx, this.app, {\n        enablePushNotifications: true,\n      });\n    }\n    try {\n      await runCredentialsManager(ctx, new SetupIosDist(this.app));\n    } catch (error: any) {\n      Log.error('Failed to set up Distribution Certificate');\n      throw error;\n    }\n\n    const distCert = await ctx.ios.getDistCert(this.app);\n    if (!distCert) {\n      throw new CommandError(\n        'INSUFFICIENT_CREDENTIALS',\n        `This build request requires a valid distribution certificate.`\n      );\n    }\n\n    try {\n      await runCredentialsManager(ctx, new SetupIosProvisioningProfile(this.app));\n    } catch (error: any) {\n      Log.error('Failed to set up Provisioning Profile');\n      throw error;\n    }\n\n    return null;\n  }\n\n  // Try to get the user to provide Apple credentials upfront\n  // We will be able to do full validation of their iOS creds this way\n  async bestEffortAppleCtx(ctx: Context): Promise<void> {\n    if (ctx.hasAppleCtx()) {\n      // skip prompts if already have apple ctx\n      return;\n    }\n\n    if (ctx.nonInteractive) {\n      return;\n    }\n\n    const confirm = await confirmAsync({\n      message: `Do you have access to the Apple account that will be used for submitting this app to the App Store?`,\n    });\n    if (confirm) {\n      return await ctx.ensureAppleCtx();\n    } else {\n      Log.log(\n        chalk.green(\n          'No problem! ðŸ‘Œ \\nWe canâ€™t auto-generate credentials if you donâ€™t have access to the main Apple account. \\nBut we can still set it up if you upload your credentials.'\n        )\n      );\n    }\n  }\n}\n\nexport class SetupIosBuildCredentialsFromLocal implements IView {\n  constructor(private app: AppLookupParams) {}\n\n  async open(ctx: Context): Promise<IView | null> {\n    let localCredentials;\n    try {\n      localCredentials = await credentialsJsonReader.readIosCredentialsAsync(ctx.projectDir);\n    } catch (error: any) {\n      Log.error(\n        'Reading credentials from credentials.json failed. Make sure this file is correct and all credentials are present there.'\n      );\n      throw error;\n    }\n\n    const team = await readAppleTeam(localCredentials.provisioningProfile);\n    await ctx.ios.updateProvisioningProfile(this.app, {\n      ...team,\n      provisioningProfile: localCredentials.provisioningProfile,\n    });\n    const credentials = await ctx.ios.getAllCredentials(this.app.accountName);\n    const distCert = await ctx.ios.getDistCert(this.app);\n    const appsUsingCert = distCert?.id\n      ? (credentials.appCredentials || []).filter(cred => cred.distCredentialsId === distCert.id)\n      : [];\n\n    const appInfo = `@${this.app.accountName}/${this.app.projectName} (${this.app.bundleIdentifier})`;\n    const newDistCert = {\n      ...team,\n      certP12: localCredentials.distributionCertificate.certP12,\n      certPassword: localCredentials.distributionCertificate.certPassword,\n    };\n\n    if (appsUsingCert.length > 1 && distCert?.id) {\n      const { update } = await prompts({\n        type: 'select',\n        name: 'update',\n        message:\n          'Current distribution certificate is used by multiple apps. Do you want to update all of them?',\n        choices: [\n          { title: 'Update all apps', value: 'all' },\n          { title: `Update only ${appInfo}`, value: 'app' },\n        ],\n      });\n      if (update === 'all') {\n        await ctx.ios.updateDistCert(distCert.id, this.app.accountName, newDistCert);\n      } else {\n        const createdDistCert = await ctx.ios.createDistCert(this.app.accountName, newDistCert);\n        await ctx.ios.useDistCert(this.app, createdDistCert.id);\n      }\n    } else if (distCert?.id) {\n      await ctx.ios.updateDistCert(distCert.id, this.app.accountName, newDistCert);\n    } else {\n      const createdDistCert = await ctx.ios.createDistCert(this.app.accountName, newDistCert);\n      await ctx.ios.useDistCert(this.app, createdDistCert.id);\n    }\n    return null;\n  }\n}\n"],"mappings":"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"}