{"version":3,"file":"SetupIosProvisioningProfile.js","names":["SetupIosProvisioningProfile","constructor","app","open","ctx","user","Error","distCert","ios","getDistCert","appCredentials","getAppCredentials","configuredProfile","getProvisioningProfile","configuredWithSameDistCert","distCredentialsId","id","iosProfileView","CreateOrReuseProvisioningProfile","hasAppleCtx","isValid","validateProfileWithoutApple","bundleIdentifier","provisioningProfileId","Log","log","chalk","yellow","profileFromApple","getAppleInfo","appleCtx","configureAndUpdateProvisioningProfile"],"sources":["../../../src/credentials/views/SetupIosProvisioningProfile.ts"],"sourcesContent":["import chalk from 'chalk';\n\nimport Log from '../../log';\nimport { AppLookupParams } from '../api/IosApi';\nimport { Context, IView } from '../context';\nimport * as iosProfileView from './IosProvisioningProfile';\n\nexport class SetupIosProvisioningProfile implements IView {\n  constructor(private app: AppLookupParams) {}\n\n  async open(ctx: Context): Promise<IView | null> {\n    if (!ctx.user) {\n      throw new Error(`This workflow requires you to be logged in.`);\n    }\n\n    const distCert = await ctx.ios.getDistCert(this.app);\n    if (!distCert) {\n      // dist cert should already be created\n      // TODO: trigger dist cert creation here\n      throw new Error('There is no distribution certificate assigned for this app');\n    }\n\n    const appCredentials = await ctx.ios.getAppCredentials(this.app);\n\n    // Try to use the profile we have on file first\n    const configuredProfile = await ctx.ios.getProvisioningProfile(this.app);\n\n    // We dont have a profile on expo servers or\n    // The configured profile is associated with some other dist cert\n    const configuredWithSameDistCert = appCredentials.distCredentialsId === distCert.id;\n    if (!configuredProfile || !configuredWithSameDistCert) {\n      return new iosProfileView.CreateOrReuseProvisioningProfile(this.app);\n    }\n\n    if (!ctx.hasAppleCtx()) {\n      const isValid = await iosProfileView.validateProfileWithoutApple(\n        configuredProfile,\n        distCert,\n        this.app.bundleIdentifier\n      );\n      if (!isValid) {\n        throw new Error(`The provisioning profile we have on file is no longer valid.`);\n      }\n      return null;\n    }\n\n    // User uploaded profiles dont have ids - do best effort validation here\n    if (!configuredProfile.provisioningProfileId) {\n      Log.log(\n        chalk.yellow(\n          \"The provisioning profile we have on file cannot be validated on Apple's servers.\"\n        )\n      );\n      const isValid = await iosProfileView.validateProfileWithoutApple(\n        configuredProfile,\n        distCert,\n        this.app.bundleIdentifier\n      );\n      if (!isValid) {\n        return new iosProfileView.CreateOrReuseProvisioningProfile(this.app);\n      }\n      return null;\n    }\n\n    const profileFromApple = await iosProfileView.getAppleInfo(\n      ctx.appleCtx,\n      this.app.bundleIdentifier,\n      configuredProfile\n    );\n\n    // Profile can't be found on Apple servers\n    if (!profileFromApple) {\n      return new iosProfileView.CreateOrReuseProvisioningProfile(this.app);\n    }\n\n    await iosProfileView.configureAndUpdateProvisioningProfile(\n      ctx,\n      this.app,\n      distCert,\n      profileFromApple\n    );\n    return null;\n  }\n}\n"],"mappings":";;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAGA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAA2D;AAAA;AAAA;AAEpD,MAAMA,2BAA2B,CAAkB;EACxDC,WAAW,CAASC,GAAoB,EAAE;IAAA,KAAtBA,GAAoB,GAApBA,GAAoB;EAAG;EAE3C,MAAMC,IAAI,CAACC,GAAY,EAAyB;IAC9C,IAAI,CAACA,GAAG,CAACC,IAAI,EAAE;MACb,MAAM,IAAIC,KAAK,CAAE,6CAA4C,CAAC;IAChE;IAEA,MAAMC,QAAQ,GAAG,MAAMH,GAAG,CAACI,GAAG,CAACC,WAAW,CAAC,IAAI,CAACP,GAAG,CAAC;IACpD,IAAI,CAACK,QAAQ,EAAE;MACb;MACA;MACA,MAAM,IAAID,KAAK,CAAC,4DAA4D,CAAC;IAC/E;IAEA,MAAMI,cAAc,GAAG,MAAMN,GAAG,CAACI,GAAG,CAACG,iBAAiB,CAAC,IAAI,CAACT,GAAG,CAAC;;IAEhE;IACA,MAAMU,iBAAiB,GAAG,MAAMR,GAAG,CAACI,GAAG,CAACK,sBAAsB,CAAC,IAAI,CAACX,GAAG,CAAC;;IAExE;IACA;IACA,MAAMY,0BAA0B,GAAGJ,cAAc,CAACK,iBAAiB,KAAKR,QAAQ,CAACS,EAAE;IACnF,IAAI,CAACJ,iBAAiB,IAAI,CAACE,0BAA0B,EAAE;MACrD,OAAO,KAAIG,cAAc,GAACC,gCAAgC,EAAC,IAAI,CAAChB,GAAG,CAAC;IACtE;IAEA,IAAI,CAACE,GAAG,CAACe,WAAW,EAAE,EAAE;MACtB,MAAMC,OAAO,GAAG,MAAMH,cAAc,GAACI,2BAA2B,CAC9DT,iBAAiB,EACjBL,QAAQ,EACR,IAAI,CAACL,GAAG,CAACoB,gBAAgB,CAC1B;MACD,IAAI,CAACF,OAAO,EAAE;QACZ,MAAM,IAAId,KAAK,CAAE,8DAA6D,CAAC;MACjF;MACA,OAAO,IAAI;IACb;;IAEA;IACA,IAAI,CAACM,iBAAiB,CAACW,qBAAqB,EAAE;MAC5CC,cAAG,CAACC,GAAG,CACLC,gBAAK,CAACC,MAAM,CACV,kFAAkF,CACnF,CACF;MACD,MAAMP,OAAO,GAAG,MAAMH,cAAc,GAACI,2BAA2B,CAC9DT,iBAAiB,EACjBL,QAAQ,EACR,IAAI,CAACL,GAAG,CAACoB,gBAAgB,CAC1B;MACD,IAAI,CAACF,OAAO,EAAE;QACZ,OAAO,KAAIH,cAAc,GAACC,gCAAgC,EAAC,IAAI,CAAChB,GAAG,CAAC;MACtE;MACA,OAAO,IAAI;IACb;IAEA,MAAM0B,gBAAgB,GAAG,MAAMX,cAAc,GAACY,YAAY,CACxDzB,GAAG,CAAC0B,QAAQ,EACZ,IAAI,CAAC5B,GAAG,CAACoB,gBAAgB,EACzBV,iBAAiB,CAClB;;IAED;IACA,IAAI,CAACgB,gBAAgB,EAAE;MACrB,OAAO,KAAIX,cAAc,GAACC,gCAAgC,EAAC,IAAI,CAAChB,GAAG,CAAC;IACtE;IAEA,MAAMe,cAAc,GAACc,qCAAqC,CACxD3B,GAAG,EACH,IAAI,CAACF,GAAG,EACRK,QAAQ,EACRqB,gBAAgB,CACjB;IACD,OAAO,IAAI;EACb;AACF;AAAC"}