{"version":3,"file":"AssetBundle.js","names":["EXPO_DOMAINS","DEFAULT_CDN_HOST","ASSETS_DIR_DEFAULT_URL","bundleAsync","context","assets","dest","exportUrl","fs","ensureDir","urlResolver","createAssetsUrlResolver","pMap","asset","downloadAssetAsync","concurrency","extensionIndex","lastIndexOf","prefixLength","length","hash","substring","console","log","pRetry","ExponentTools","saveUrlToPathAsync","path","join","retries","assetsDirUrl","published","url","assetUrlOverride","config","publishedUrl","hostname","parse","Error","maybeExpoDomain","split","slice","includes","resolve","urlJoin"],"sources":["../../src/detach/AssetBundle.ts"],"sourcesContent":["import fs from 'fs-extra';\nimport pMap from 'p-map';\nimport pRetry from 'p-retry';\nimport path from 'path';\nimport url from 'url';\nimport urlJoin from 'url-join';\n\nimport { AnyStandaloneContext, ExponentTools } from '../internal';\n\nconst EXPO_DOMAINS = ['expo.io', 'exp.host', 'expo.test', 'localhost'];\nexport const DEFAULT_CDN_HOST = 'https://classic-assets.eascdn.net';\nexport const ASSETS_DIR_DEFAULT_URL = `${DEFAULT_CDN_HOST}/~assets`;\n\ntype UrlResolver = (hash: string) => string;\n\nexport async function bundleAsync(\n  context: any,\n  assets: string[],\n  dest: string,\n  exportUrl?: string | null\n) {\n  if (!assets) {\n    return;\n  }\n\n  await fs.ensureDir(dest);\n\n  const urlResolver = createAssetsUrlResolver(context, exportUrl);\n  await pMap(assets, asset => downloadAssetAsync(urlResolver, dest, asset), { concurrency: 5 });\n}\n\nasync function downloadAssetAsync(urlResolver: UrlResolver, dest: string, asset: string) {\n  const extensionIndex = asset.lastIndexOf('.');\n  const prefixLength = 'asset_'.length;\n  const hash =\n    extensionIndex >= 0\n      ? asset.substring(prefixLength, extensionIndex)\n      : asset.substring(prefixLength);\n  console.log(urlResolver(hash));\n  await pRetry(() => ExponentTools.saveUrlToPathAsync(urlResolver(hash), path.join(dest, asset)), {\n    retries: 3,\n  });\n}\n\nfunction createAssetsUrlResolver(\n  context: AnyStandaloneContext,\n  exportUrl?: string | null\n): UrlResolver {\n  let assetsDirUrl = exportUrl ? `${exportUrl}/assets` : ASSETS_DIR_DEFAULT_URL;\n\n  if (context && context.published && context.published.url) {\n    const { assetUrlOverride = './assets' } = context.config;\n    const publishedUrl = context.published.url;\n    const { hostname } = url.parse(publishedUrl);\n    if (hostname == null) {\n      throw new Error(\n        `Could not resolve asset URLs relative to \"${publishedUrl}\". Published URL must be an absolute URL.`\n      );\n    }\n    const maybeExpoDomain = hostname.split('.').slice(-2).join('.');\n    if (!EXPO_DOMAINS.includes(maybeExpoDomain)) {\n      assetsDirUrl = url.resolve(publishedUrl, assetUrlOverride);\n    }\n  }\n\n  return hash => urlJoin(assetsDirUrl, hash);\n}\n"],"mappings":"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"}