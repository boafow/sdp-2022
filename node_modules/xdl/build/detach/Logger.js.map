{"version":3,"file":"Logger.js","names":["LogLevel","Logger","constructor","bunyanGetter","extraFields","loggerObj","bunyan","createLogger","name","loggerGetter","configure","withFields","getter","trace","all","logLine","debug","info","warn","error","fatal","level","args","argsToLog","extraFieldsFromArgsExist","isPlainObject","extraFieldsFromArgs","shift","isEmpty","unshift","LoggerDetach","pipeOutputToLogger","stdout","stderr","stdoutOnly","loggerLineTransformer","on","chunk","logMultiline","source","data","lines","String","split","forEach","line","lineToPrint"],"sources":["../../src/detach/Logger.ts"],"sourcesContent":["import bunyan from '@expo/bunyan';\nimport isEmpty from 'lodash/isEmpty';\nimport isPlainObject from 'lodash/isPlainObject';\nimport { Readable } from 'stream';\n\nexport enum LogLevel {\n  trace = 'trace',\n  debug = 'debug',\n  info = 'info',\n  warn = 'warn',\n  error = 'error',\n  fatal = 'fatal',\n}\n\ntype BunyanGetter = () => bunyan;\n\nexport class Logger {\n  loggerObj: bunyan;\n  loggerGetter?: BunyanGetter;\n  extraFields: any;\n\n  constructor(bunyanGetter?: BunyanGetter, extraFields?: any) {\n    this.loggerObj = bunyan.createLogger({ name: 'xdl-detach' });\n    this.loggerGetter = bunyanGetter;\n    this.extraFields = extraFields;\n  }\n\n  configure(loggerObj: bunyan) {\n    this.loggerObj = loggerObj;\n  }\n\n  withFields(extraFields: any) {\n    const getter = this.loggerGetter || (() => this.loggerObj);\n    return new Logger(getter, { ...this.extraFields, ...extraFields });\n  }\n\n  trace(...all: any[]) {\n    this.logLine(LogLevel.trace, ...all);\n  }\n  debug(...all: any[]) {\n    this.logLine(LogLevel.debug, ...all);\n  }\n  info(...all: any[]) {\n    this.logLine(LogLevel.info, ...all);\n  }\n  warn(...all: any[]) {\n    this.logLine(LogLevel.warn, ...all);\n  }\n  error(...all: any[]) {\n    this.logLine(LogLevel.error, ...all);\n  }\n  fatal(...all: any[]) {\n    this.logLine(LogLevel.fatal, ...all);\n  }\n\n  logLine(level: LogLevel, ...args: any[]) {\n    const argsToLog = [...args];\n    const extraFieldsFromArgsExist = isPlainObject(args[0]);\n    const extraFieldsFromArgs = extraFieldsFromArgsExist ? args[0] : {};\n    if (extraFieldsFromArgsExist) {\n      argsToLog.shift();\n    }\n    const extraFields = { ...extraFieldsFromArgs, ...this.extraFields };\n    if (!isEmpty(extraFields)) {\n      argsToLog.unshift(extraFields);\n    }\n\n    if (this.loggerGetter) {\n      const loggerObj = this.loggerGetter();\n      loggerObj[level](...argsToLog);\n    } else {\n      this.loggerObj[level](...argsToLog);\n    }\n  }\n}\n\nconst LoggerDetach = new Logger();\nexport default LoggerDetach;\n\nexport function pipeOutputToLogger(\n  { stdout, stderr }: { stdout?: Readable | null; stderr?: Readable | null } = {\n    stdout: null,\n    stderr: null,\n  },\n  extraFields = {},\n  {\n    stdoutOnly = false,\n    loggerLineTransformer,\n  }: { stdoutOnly?: boolean; loggerLineTransformer?: (line: any) => any } = {}\n) {\n  if (stdout) {\n    stdout.on('data', chunk =>\n      logMultiline(chunk, { ...extraFields, source: 'stdout' }, loggerLineTransformer)\n    );\n  }\n  if (stderr) {\n    const source = stdoutOnly ? 'stdout' : 'stderr';\n    stderr.on('data', chunk =>\n      logMultiline(chunk, { ...extraFields, source }, loggerLineTransformer)\n    );\n  }\n}\n\nfunction logMultiline(data: any, extraFields: any, loggerLineTransformer?: (line: any) => any) {\n  if (!data) {\n    return;\n  }\n  const lines = String(data).split('\\n');\n  lines.forEach(line => {\n    const lineToPrint = loggerLineTransformer ? loggerLineTransformer(line) : line;\n    if (lineToPrint) {\n      const args = [lineToPrint];\n      if (!isEmpty(extraFields)) {\n        args.unshift(extraFields);\n      }\n      LoggerDetach.info(...args);\n    }\n  });\n}\n"],"mappings":"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"}