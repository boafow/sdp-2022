{"version":3,"file":"PackagerLogsStream.js","names":["PackagerLogsStream","constructor","projectRoot","getCurrentOpenProjectId","updateLogs","onStartBuildBundle","onProgressBuildBundle","onFinishBuildBundle","getSnippetForError","chunk","msg","bundleDetails","bundleDetailsCache","buildID","type","String","_metroEventType","_handleNewBundleTransformStarted","_bundleBuildChunkID","_handleUpdateBundleTransformProgress","_updateLogs","logs","_logsToAdd","length","nextLogs","concat","match","replace","_projectRoot","_getCurrentOpenProjectId","_onStartBuildBundle","_onProgressBuildBundle","_onFinishBuildBundle","_getSnippetForError","_attachLoggerStream","projectId","ProjectUtils","attachLoggerStream","stream","write","_handleChunk","bind","tag","_maybeParseMsgJSON","_cleanUpNodeErrors","_handleMetroEvent","_enqueueAppendLogChunk","originalChunk","includes","getenv","boolish","_handleBundleTransformEvent","code","error","port","_formatModuleResolutionError","_formatBundlingError","level","Logger","ERROR","warning","WARN","reason","_formatWorkerChunk","JSON","stringify","getPlatformTagForBuildDetails","platform","formatted","ios","android","web","chalk","bold","id","_bundleBuildStart","Date","progressChunk","percentProgress","bundleComplete","duration","getTime","percentage","transformedFileCount","totalFileCount","roundedPercentProgress","Math","floor","progress","start","end","forEach","log","message","exec","originModulePath","moduleName","relativePath","path","relative","DOCS_PAGE_URL","NODE_STDLIB_MODULES","Array","isArray","errors","description","red","snippet","isAmbiguousError","name","isComprehensiveTransformError","filename","stack","gray","origin","shouldHide","push","_enqueueFlushLogsToAdd","parsedMsg","parse"],"sources":["../../src/logs/PackagerLogsStream.ts"],"sourcesContent":["import { JSONObject } from '@expo/json-file';\nimport chalk from 'chalk';\nimport getenv from 'getenv';\nimport path from 'path';\n\nimport { Logger, ProjectUtils } from '../internal';\n\ntype BuildEventType =\n  | 'METRO_INITIALIZE_STARTED'\n  | 'BUILD_STARTED'\n  | 'BUILD_PROGRESS'\n  | 'BUILD_FAILED'\n  | 'BUILD_DONE';\ntype MetroLogRecord = {\n  tag: 'metro';\n  id: string;\n  shouldHide: boolean;\n  msg: ReportableEvent | string;\n  level: number;\n  _metroEventType?: BuildEventType;\n};\ntype ExpoLogRecord = {\n  tag: 'expo';\n  id: string;\n  shouldHide: boolean;\n  msg: any;\n  level: number;\n};\ntype DeviceLogRecord = {\n  tag: 'device';\n  id: string;\n  shouldHide: boolean;\n  msg: any;\n  level: number;\n  deviceId: string;\n  deviceName: string;\n};\nexport type LogRecord = (MetroLogRecord | ExpoLogRecord | DeviceLogRecord) & ProjectUtils.LogFields;\n\nexport type LogUpdater = (logState: LogRecord[]) => LogRecord[];\n\ntype ErrorObject = {\n  name?: string;\n  stack?: string;\n  message?: string;\n  code?: string;\n} & JSONObject;\n\ntype MetroError =\n  | ({\n      originModulePath: string;\n      message: string;\n      errors: { description: string; filename: string; lineNumber: number }[];\n    } & ErrorObject)\n  | ({\n      type: 'TransformError';\n      snippet: string;\n      lineNumber: number;\n      column: number;\n      filename: string;\n      errors: { description: string; filename: string; lineNumber: number }[];\n    } & ErrorObject)\n  | ErrorObject;\n\n// Metro reporter types\n// https://github.com/facebook/metro/blob/2a327fb19dd62169ab3ae9069011d8a599cfcf3e/packages/metro/src/lib/reporting.js\ntype GlobalCacheDisabledReason = 'too_many_errors' | 'too_many_misses';\ntype BundleDetails = {\n  entryFile: string;\n  platform: string;\n  dev: boolean;\n  minify: boolean;\n  bundleType: string;\n};\ntype ReportableEvent =\n  | {\n      port: number | undefined;\n      projectRoots: readonly string[];\n      type: 'initialize_started';\n    }\n  | {\n      type: 'initialize_done';\n    }\n  | {\n      type: 'client_log';\n      data: any;\n    }\n  | {\n      type: 'initialize_failed';\n      port: number;\n      error: MetroError;\n    }\n  | {\n      buildID: string;\n      type: 'bundle_build_done';\n    }\n  | {\n      buildID: string;\n      type: 'bundle_build_failed';\n    }\n  | {\n      buildID: string;\n      bundleDetails: BundleDetails;\n      type: 'bundle_build_started';\n    }\n  | {\n      error: MetroError;\n      type: 'bundling_error';\n    }\n  | {\n      // Currently only sent from Webpack\n      warning: string;\n      type: 'bundling_warning';\n    }\n  | {\n      type: 'dep_graph_loading';\n    }\n  | {\n      type: 'dep_graph_loaded';\n    }\n  | {\n      buildID: string;\n      type: 'bundle_transform_progressed';\n      transformedFileCount: number;\n      totalFileCount: number;\n\n      // A special property added for webpack support\n      percentage?: number;\n    }\n  | {\n      type: 'global_cache_error';\n      error: MetroError;\n    }\n  | {\n      type: 'global_cache_disabled';\n      reason: GlobalCacheDisabledReason;\n    }\n  | {\n      type: 'transform_cache_reset';\n    }\n  | {\n      type: 'worker_stdout_chunk';\n      chunk: string;\n    }\n  | {\n      type: 'worker_stderr_chunk';\n      chunk: string;\n    }\n  | {\n      type: 'transformer_load_started';\n    }\n  | {\n      type: 'transformer_load_done';\n    }\n  | {\n      type: 'hmr_client_error';\n      error: MetroError;\n    };\n\ntype StartBuildBundleCallback = (props: {\n  chunk: LogRecord;\n  bundleDetails: BundleDetails | null;\n}) => void;\ntype ProgressBuildBundleCallback = (props: {\n  progress: number;\n  start: Date | null;\n  chunk: any;\n  bundleDetails: BundleDetails | null;\n}) => void;\ntype FinishBuildBundleCallback = (props: {\n  error: string | null;\n  start: Date;\n  end: Date;\n  chunk: MetroLogRecord;\n  bundleDetails: BundleDetails | null;\n}) => void;\n\nexport default class PackagerLogsStream {\n  _projectRoot: string;\n  _getCurrentOpenProjectId: () => any;\n  _updateLogs: (updater: LogUpdater) => void;\n  _logsToAdd: LogRecord[] = [];\n  _bundleBuildChunkID: string | null = null;\n  _onStartBuildBundle?: StartBuildBundleCallback;\n  _onProgressBuildBundle?: ProgressBuildBundleCallback;\n  _onFinishBuildBundle?: FinishBuildBundleCallback;\n  _bundleBuildStart: Date | null = null;\n  _getSnippetForError?: (error: MetroError) => string | null;\n\n  constructor({\n    projectRoot,\n    getCurrentOpenProjectId,\n    updateLogs,\n    onStartBuildBundle,\n    onProgressBuildBundle,\n    onFinishBuildBundle,\n    getSnippetForError,\n  }: {\n    projectRoot: string;\n    getCurrentOpenProjectId?: () => any;\n    updateLogs: (updater: LogUpdater) => void;\n    onStartBuildBundle?: StartBuildBundleCallback;\n    onProgressBuildBundle?: ProgressBuildBundleCallback;\n    onFinishBuildBundle?: FinishBuildBundleCallback;\n    getSnippetForError?: (error: MetroError) => string | null;\n  }) {\n    this._projectRoot = projectRoot;\n    this._getCurrentOpenProjectId = getCurrentOpenProjectId || (() => 1);\n    this._updateLogs = updateLogs;\n\n    // Optional properties in case the consumer wants to handle updates on\n    // its own, eg: for a progress bar\n    this._onStartBuildBundle = onStartBuildBundle;\n    this._onProgressBuildBundle = onProgressBuildBundle;\n    this._onFinishBuildBundle = onFinishBuildBundle;\n\n    // Optional function for creating custom code frame snippet\n    // (e.g. with terminal colors) from a syntax error.\n    this._getSnippetForError = getSnippetForError;\n\n    this._attachLoggerStream();\n  }\n\n  projectId?: number;\n\n  _attachLoggerStream() {\n    this.projectId = this._getCurrentOpenProjectId();\n\n    ProjectUtils.attachLoggerStream(this._projectRoot, {\n      stream: {\n        write: this._handleChunk.bind(this),\n      },\n      type: 'raw',\n    });\n  }\n\n  _handleChunk(chunk: LogRecord) {\n    if (chunk.tag !== 'metro' && chunk.tag !== 'expo') {\n      return;\n    } else if (this._getCurrentOpenProjectId() !== this.projectId) {\n      // TODO: We should be confident that we are properly unsubscribing\n      // from the stream rather than doing a defensive check like this.\n      return;\n    }\n\n    chunk = this._maybeParseMsgJSON(chunk);\n    chunk = this._cleanUpNodeErrors(chunk);\n    if (chunk.tag === 'metro') {\n      this._handleMetroEvent(chunk);\n    } else if (typeof chunk.msg === 'string' && chunk.msg.match(/\\w/) && chunk.msg[0] !== '{') {\n      this._enqueueAppendLogChunk(chunk);\n    }\n  }\n\n  _handleMetroEvent(originalChunk: MetroLogRecord) {\n    const chunk = { ...originalChunk };\n    const { msg } = chunk;\n\n    if (typeof msg === 'string') {\n      if ((msg as string).includes('HTTP/1.1') && !getenv.boolish('EXPO_DEBUG', false)) {\n        // Do nothing with this message - we want to filter out network requests logged by Metro.\n      } else {\n        // If Metro crashes for some reason, it may log an error message as a plain string to stderr.\n        this._enqueueAppendLogChunk(chunk);\n      }\n      return;\n    }\n\n    switch (msg.type) {\n      // Bundle transform events\n      case 'bundle_build_started':\n      case 'bundle_transform_progressed':\n      case 'bundle_build_failed':\n      case 'bundle_build_done':\n        this._handleBundleTransformEvent(chunk);\n        return;\n\n      case 'initialize_started':\n        chunk._metroEventType = 'METRO_INITIALIZE_STARTED';\n        chunk.msg = 'Starting Metro Bundler';\n        break;\n      case 'initialize_done':\n        chunk.msg = `Started Metro Bundler`;\n        break;\n      case 'initialize_failed': {\n        // SDK <=22\n        const code = msg.error.code;\n        chunk.msg =\n          code === 'EADDRINUSE'\n            ? `Metro Bundler can't listen on port ${msg.port}. The port is in use.`\n            : `Metro Bundler failed to start. (code: ${code})`;\n        break;\n      }\n      case 'bundling_error':\n        chunk.msg =\n          this._formatModuleResolutionError(msg.error) ||\n          this._formatBundlingError(msg.error) ||\n          msg;\n        chunk.level = Logger.ERROR;\n        break;\n      case 'bundling_warning':\n        chunk.msg = msg.warning;\n        chunk.level = Logger.WARN;\n        break;\n      case 'transform_cache_reset':\n        chunk.msg =\n          'Your JavaScript transform cache is empty, rebuilding (this may take a minute).';\n        break;\n      case 'hmr_client_error':\n        chunk.msg = `A WebSocket client got a connection error. Please reload your device to get HMR working again.`;\n        break;\n      case 'global_cache_disabled':\n        if (msg.reason === 'too_many_errors') {\n          chunk.msg =\n            'The global cache is now disabled because it has been failing too many times.';\n        } else if (msg.reason === 'too_many_misses') {\n          chunk.msg = `The global cache is now disabled because it has been missing too many consecutive keys.`;\n        } else {\n          chunk.msg = `The global cache is now disabled. Reason: ${msg.reason}`;\n        }\n        break;\n      case 'worker_stdout_chunk':\n        chunk.msg = this._formatWorkerChunk('stdout', msg.chunk);\n        break;\n      case 'worker_stderr_chunk':\n        chunk.msg = this._formatWorkerChunk('stderr', msg.chunk);\n        break;\n      // Ignored events.\n      case 'client_log':\n      case 'dep_graph_loading':\n      case 'dep_graph_loaded':\n      case 'global_cache_error':\n      case 'transformer_load_started':\n      case 'transformer_load_done':\n        return;\n      default:\n        chunk.msg = `Unrecognized event: ${JSON.stringify(msg)}`;\n        break;\n    }\n    this._enqueueAppendLogChunk(chunk);\n  }\n\n  // A cache of { [buildID]: BundleDetails } which can be used to\n  // add more contextual logs. BundleDetails is currently only sent with `bundle_build_started`\n  // so we need to cache the details in order to print the platform info with other event types.\n  bundleDetailsCache: Record<string, BundleDetails> = {};\n\n  // Any event related to bundle building is handled here\n  _handleBundleTransformEvent = (chunk: MetroLogRecord) => {\n    const msg = chunk.msg as ReportableEvent;\n\n    const bundleDetails = 'buildID' in msg ? this.bundleDetailsCache[msg.buildID] || null : null;\n\n    if (msg.type === 'bundle_build_started') {\n      // Cache bundle details for later.\n      this.bundleDetailsCache[String(msg.buildID)] = msg.bundleDetails;\n      chunk._metroEventType = 'BUILD_STARTED';\n      this._handleNewBundleTransformStarted(chunk, msg.bundleDetails);\n    } else if (msg.type === 'bundle_transform_progressed' && this._bundleBuildChunkID) {\n      chunk._metroEventType = 'BUILD_PROGRESS';\n      this._handleUpdateBundleTransformProgress(chunk, bundleDetails);\n    } else if (msg.type === 'bundle_build_failed' && this._bundleBuildChunkID) {\n      chunk._metroEventType = 'BUILD_FAILED';\n      this._handleUpdateBundleTransformProgress(chunk, bundleDetails);\n    } else if (msg.type === 'bundle_build_done' && this._bundleBuildChunkID) {\n      chunk._metroEventType = 'BUILD_DONE';\n      this._handleUpdateBundleTransformProgress(chunk, bundleDetails);\n    }\n  };\n\n  static getPlatformTagForBuildDetails(bundleDetails?: BundleDetails | null) {\n    const platform = bundleDetails?.platform ?? null;\n    if (platform) {\n      const formatted = { ios: 'iOS', android: 'Android', web: 'Web' }[platform] || platform;\n      return `${chalk.bold(formatted)} `;\n    }\n\n    return '';\n  }\n\n  private _handleNewBundleTransformStarted(\n    chunk: MetroLogRecord,\n    bundleDetails: BundleDetails | null\n  ) {\n    if (this._bundleBuildChunkID) {\n      return;\n    }\n\n    this._bundleBuildChunkID = chunk.id;\n    this._bundleBuildStart = new Date();\n\n    chunk.msg = 'Building JavaScript bundle';\n\n    if (this._onStartBuildBundle) {\n      this._onStartBuildBundle({ chunk, bundleDetails });\n    } else {\n      this._enqueueAppendLogChunk(chunk);\n    }\n  }\n\n  private _handleUpdateBundleTransformProgress(\n    progressChunk: MetroLogRecord,\n    bundleDetails: BundleDetails | null\n  ) {\n    const msg = progressChunk.msg as ReportableEvent;\n\n    let percentProgress;\n    let bundleComplete = false;\n    if (msg.type === 'bundle_build_done') {\n      percentProgress = 100;\n      bundleComplete = true;\n      if (this._bundleBuildStart) {\n        const duration = new Date().getTime() - this._bundleBuildStart.getTime();\n        progressChunk.msg = `Building JavaScript bundle: finished in ${duration}ms.`;\n      } else {\n        progressChunk.msg = `Building JavaScript bundle: finished.`;\n      }\n    } else if (msg.type === 'bundle_build_failed') {\n      percentProgress = -1;\n      bundleComplete = true;\n      progressChunk.msg = `Building JavaScript bundle: error`;\n      progressChunk.level = Logger.ERROR;\n    } else if (msg.type === 'bundle_transform_progressed') {\n      if (msg.percentage) {\n        percentProgress = msg.percentage * 100;\n      } else {\n        percentProgress = (msg.transformedFileCount / msg.totalFileCount) * 100;\n        // percentProgress = Math.floor((msg.transformedFileCount / msg.totalFileCount) * 100);\n      }\n      const roundedPercentProgress = Math.floor(100 * percentProgress) / 100;\n      progressChunk.msg = `Building JavaScript bundle: ${roundedPercentProgress}%`;\n    } else {\n      return;\n    }\n\n    if (this._bundleBuildChunkID) {\n      progressChunk.id = this._bundleBuildChunkID;\n    }\n\n    if (this._onProgressBuildBundle) {\n      this._onProgressBuildBundle({\n        progress: percentProgress,\n        start: this._bundleBuildStart,\n        chunk: progressChunk,\n        bundleDetails,\n      });\n\n      if (bundleComplete) {\n        if (this._onFinishBuildBundle && this._bundleBuildStart) {\n          const error = msg.type === 'bundle_build_failed' ? 'Build failed' : null;\n          this._onFinishBuildBundle({\n            error,\n            start: this._bundleBuildStart,\n            end: new Date(),\n            chunk: progressChunk,\n            bundleDetails,\n          });\n        }\n        this._bundleBuildStart = null;\n        this._bundleBuildChunkID = null;\n      }\n    } else {\n      this._updateLogs(logs => {\n        if (!logs || !logs.length) {\n          return [];\n        }\n\n        logs.forEach(log => {\n          if (log.id === this._bundleBuildChunkID) {\n            log.msg = progressChunk.msg;\n          }\n        });\n\n        if (bundleComplete) {\n          this._bundleBuildChunkID = null;\n        }\n\n        return [...logs];\n      });\n    }\n  }\n\n  _formatModuleResolutionError(error: MetroError): string | null {\n    if (!error.message) {\n      return null;\n    }\n    const match = /^Unable to resolve module `(.+?)`/.exec(error.message);\n    const originModulePath = error.originModulePath as string | null;\n    if (!match || !originModulePath) {\n      return null;\n    }\n    const moduleName = match[1];\n    const relativePath = path.relative(this._projectRoot, originModulePath);\n\n    const DOCS_PAGE_URL =\n      'https://docs.expo.dev/workflow/using-libraries/#using-third-party-libraries';\n\n    if (NODE_STDLIB_MODULES.includes(moduleName)) {\n      if (originModulePath.includes('node_modules')) {\n        return `The package at \"${relativePath}\" attempted to import the Node standard library module \"${moduleName}\". It failed because the native React runtime does not include the Node standard library. Read more at ${DOCS_PAGE_URL}`;\n      } else {\n        return `You attempted attempted to import the Node standard library module \"${moduleName}\" from \"${relativePath}\". It failed because the native React runtime does not include the Node standard library. Read more at ${DOCS_PAGE_URL}`;\n      }\n    }\n    return `Unable to resolve \"${moduleName}\" from \"${relativePath}\"`;\n  }\n\n  _formatBundlingError(error: MetroError): string | null {\n    let message = error.message;\n    if (!message && Array.isArray(error.errors) && error.errors.length) {\n      message = (error.errors[0] as any).description;\n    }\n    if (!message) {\n      return null;\n    }\n\n    message = chalk.red(message);\n\n    const snippet = (this._getSnippetForError && this._getSnippetForError(error)) || error.snippet;\n    if (snippet) {\n      message += `\\n${snippet}`;\n    }\n\n    // Import errors are already pretty useful and don't need extra info added to them.\n    const isAmbiguousError = !error.name || ['SyntaxError'].includes(error.name);\n    // When you have a basic syntax error in application code it will tell you the file\n    // and usually also provide a well informed error.\n    const isComprehensiveTransformError = error.type === 'TransformError' && error.filename;\n\n    // console.log(require('util').inspect(error, { depth: 4 }));\n    if (error.stack && isAmbiguousError && !isComprehensiveTransformError) {\n      message += `\\n${chalk.gray(error.stack)}`;\n    }\n    return message;\n  }\n\n  _formatWorkerChunk(origin: 'stdout' | 'stderr', chunk: string) {\n    return chunk;\n    // const lines = chunk.split('\\n');\n    // if (lines.length >= 1 && lines[lines.length - 1] === '') {\n    //   lines.splice(lines.length - 1, 1);\n    // }\n    // return lines.map(line => `transform[${origin}]: ${line}`).join('\\n');\n  }\n\n  _enqueueAppendLogChunk(chunk: LogRecord) {\n    if (!chunk.shouldHide) {\n      this._logsToAdd.push(chunk);\n      this._enqueueFlushLogsToAdd();\n    }\n  }\n\n  _enqueueFlushLogsToAdd = () => {\n    this._updateLogs(logs => {\n      if (this._logsToAdd.length === 0) {\n        return logs;\n      }\n\n      const nextLogs = logs.concat(this._logsToAdd);\n      this._logsToAdd = [];\n      return nextLogs;\n    });\n  };\n\n  _maybeParseMsgJSON(chunk: LogRecord) {\n    try {\n      const parsedMsg = JSON.parse(chunk.msg);\n      chunk.msg = parsedMsg;\n    } catch {\n      // non-JSON message\n    }\n\n    return chunk;\n  }\n\n  _cleanUpNodeErrors = (chunk: LogRecord) => {\n    if (typeof chunk.msg !== 'string') {\n      return chunk;\n    }\n\n    if (chunk.msg.match(/\\(node:.\\d*\\)/)) {\n      // Example: (node:13817) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): SyntaxError: SyntaxError /Users/brent/universe/apps/new-project-template/main.js: Unexpected token (10:6)\n      // The first part of this is totally useless, so let's remove it.\n      if (chunk.msg.match(/UnhandledPromiseRejectionWarning/)) {\n        chunk.msg = chunk.msg.replace(/\\(node:.*\\(rejection .*\\):/, '');\n        if (chunk.msg.match(/SyntaxError: SyntaxError/)) {\n          chunk.msg = chunk.msg.replace('SyntaxError: ', '');\n        }\n      } else if (chunk.msg.match(/DeprecationWarning/)) {\n        chunk.msg = '';\n      }\n    }\n\n    return chunk;\n  };\n}\n\nconst NODE_STDLIB_MODULES = [\n  'assert',\n  'async_hooks',\n  'buffer',\n  'child_process',\n  'cluster',\n  'crypto',\n  'dgram',\n  'dns',\n  'domain',\n  'events',\n  'fs',\n  'http',\n  'https',\n  'net',\n  'os',\n  'path',\n  'punycode',\n  'querystring',\n  'readline',\n  'repl',\n  'stream',\n  'string_decoder',\n  'tls',\n  'tty',\n  'url',\n  'util',\n  'v8',\n  'vm',\n  'zlib',\n];\n"],"mappings":"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"}