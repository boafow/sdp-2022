{"version":3,"file":"LoadingPageHandler.js","names":["LoadingEndpoint","DeepLinkEndpoint","onDeepLink","setOnDeepLink","listener","getPlatform","query","userAgent","match","getRuntimeVersion","exp","platform","getRuntimeVersionNullable","noCacheMiddleware","res","setHeader","loadingEndpointHandler","projectRoot","req","content","readFile","resolve","__dirname","toString","getConfig","skipSDKVersionRequirement","scheme","ProjectSettings","readAsync","appName","getNameFromConfig","parse","url","headers","runtimeVersion","replace","getSDKVersion","end","deeplinkEndpointHandler","isDevClient","projectUrl","UrlUtils","constructDevClientUrlAsync","constructManifestUrlAsync","statusCode","getLoadingPageHandler","next","pathname","exception","JSON","stringify","error"],"sources":["../../src/start/LoadingPageHandler.ts"],"sourcesContent":["import { ExpoConfig, getConfig, getNameFromConfig } from '@expo/config';\nimport { getRuntimeVersionNullable, getSDKVersion } from '@expo/config-plugins/build/utils/Updates';\nimport express from 'express';\nimport { readFile } from 'fs-extra';\nimport http from 'http';\nimport { resolve } from 'path';\nimport { parse } from 'url';\n\nimport { ProjectSettings, UrlUtils } from './../internal';\n\nexport const LoadingEndpoint = '/_expo/loading';\nexport const DeepLinkEndpoint = '/_expo/link';\n\ntype OnDeepLinkListener = (\n  projectRoot: string,\n  isDevClient: boolean,\n  platform: string | null\n) => Promise<void>;\n\nlet onDeepLink: OnDeepLinkListener = async () => {};\n\nexport function setOnDeepLink(listener: OnDeepLinkListener) {\n  onDeepLink = listener;\n}\n\nfunction getPlatform(\n  query: { [x: string]: string | string[] | null },\n  userAgent: string | null = null\n): 'android' | 'ios' | null {\n  if (query['platform'] === 'android' || query['platform'] === 'ios') {\n    return query['platform'];\n  }\n\n  if (userAgent?.match(/Android/i)) {\n    return 'android';\n  }\n\n  if (userAgent?.match(/iPhone|iPad/i)) {\n    return 'ios';\n  }\n\n  return null;\n}\n\nfunction getRuntimeVersion(exp: ExpoConfig, platform: 'android' | 'ios' | null) {\n  if (!platform) {\n    return null;\n  }\n\n  return getRuntimeVersionNullable(exp, platform);\n}\n\nexport function noCacheMiddleware(\n  res: express.Response | http.ServerResponse\n): express.Response | http.ServerResponse {\n  res.setHeader('Cache-Control', 'private, no-cache, no-store, must-revalidate');\n  res.setHeader('Expires', '-1');\n  res.setHeader('Pragma', 'no-cache');\n  return res;\n}\n\nasync function loadingEndpointHandler(\n  projectRoot: string,\n  req: express.Request | http.IncomingMessage,\n  res: express.Response | http.ServerResponse\n) {\n  res.setHeader('Content-Type', 'text/html');\n\n  let content = (\n    await readFile(resolve(__dirname, './../../static/loading-page/index.html'))\n  ).toString('utf-8');\n\n  const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n  const { scheme } = await ProjectSettings.readAsync(projectRoot);\n  const { appName } = getNameFromConfig(exp);\n  const { query } = parse(req.url!, true);\n  const platform = getPlatform(query, req.headers['user-agent']);\n  const runtimeVersion = getRuntimeVersion(exp, platform);\n\n  content = content.replace(/{{\\s*AppName\\s*}}/, appName ?? 'App');\n\n  content = content.replace(\n    /{{\\s*ProjectVersionType\\s*}}/,\n    runtimeVersion ? 'Runtime version' : 'SDK version'\n  );\n\n  content = content.replace(\n    /{{\\s*ProjectVersion\\s*}}/,\n    runtimeVersion ? runtimeVersion : getSDKVersion(exp) ?? 'Undetected'\n  );\n\n  content = content.replace(/{{\\s*Path\\s*}}/, projectRoot);\n  content = content.replace(/{{\\s*Scheme\\s*}}/, scheme ?? 'Unknown');\n\n  res.end(content);\n}\n\nasync function deeplinkEndpointHandler(\n  projectRoot: string,\n  req: express.Request | http.IncomingMessage,\n  res: express.Response | http.ServerResponse\n) {\n  const { query } = parse(req.url!, true);\n  const isDevClient = query['choice'] === 'expo-dev-client';\n  const projectUrl = isDevClient\n    ? await UrlUtils.constructDevClientUrlAsync(projectRoot)\n    : await UrlUtils.constructManifestUrlAsync(projectRoot);\n\n  res.setHeader('Location', projectUrl);\n\n  onDeepLink(projectRoot, isDevClient, getPlatform(query, req.headers['user-agent']));\n\n  res.setHeader('Cache-Control', 'private, no-cache, no-store, must-revalidate');\n  res.setHeader('Expires', '-1');\n  res.setHeader('Pragma', 'no-cache');\n\n  res.statusCode = 307;\n  res.end();\n}\n\nexport function getLoadingPageHandler(projectRoot: string) {\n  return async (\n    req: express.Request | http.IncomingMessage,\n    res: express.Response | http.ServerResponse,\n    next: (err?: Error) => void\n  ) => {\n    if (!req.url) {\n      next();\n      return;\n    }\n\n    try {\n      const url = parse(req.url).pathname || req.url;\n      switch (url) {\n        case LoadingEndpoint:\n          await loadingEndpointHandler(projectRoot, req, noCacheMiddleware(res));\n          break;\n        case DeepLinkEndpoint:\n          await deeplinkEndpointHandler(projectRoot, req, noCacheMiddleware(res));\n          break;\n        default:\n          next();\n      }\n    } catch (exception) {\n      res.statusCode = 520;\n      if (typeof exception == 'object' && exception != null) {\n        res.end(\n          JSON.stringify({\n            error: exception.toString(),\n          })\n        );\n      } else {\n        res.end(`Unexpected error: ${exception}`);\n      }\n    }\n  };\n}\n"],"mappings":"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"}