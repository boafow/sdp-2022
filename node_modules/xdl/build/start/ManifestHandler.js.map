{"version":3,"file":"ManifestHandler.js","names":["_cachedSignedManifest","manifestString","signedManifest","blacklistedEnvironmentVariables","Set","shouldExposeEnvironmentVariableInManifest","key","has","toUpperCase","startsWith","stripPort","host","URL","hostname","getPackagerOptionsAsync","projectRoot","projectSettings","ProjectSettings","readAsync","bundleUrlPackagerOpts","JSON","parse","stringify","urlType","hostType","getBundleUrlAsync","platform","mainModuleName","queryParams","UrlUtils","constructBundleQueryParams","path","encodeURI","encodeURIComponent","constructBundleUrlAsync","getPlatformFromRequest","headers","toString","getManifestHandler","req","res","next","url","includes","pathname","Doctor","validateWithNetworkAsync","catch","error","ProjectUtils","logError","exp","hostInfo","getManifestResponseFromHeadersAsync","sdkVersion","setHeader","end","Analytics","logEvent","developerTool","Config","e","stack","statusCode","deviceIds","saveDevicesAsync","acceptSignature","getManifestResponseAsync","getExpoGoConfig","debuggerHost","logUrl","Promise","all","constructDebuggerHostAsync","constructLogUrlAsync","developer","tool","packagerOpts","__flipperHack","projectConfig","getConfig","skipSDKVersionRequirement","entryPoint","resolveEntryPoint","stripJSExtension","createHostInfoAsync","expoGoConfig","hostUri","constructHostUriAsync","manifest","Versions","lteSdkVersion","env","getManifestEnvironment","bundleUrl","ProjectAssets","resolveManifestAssets","resolver","match","resolveGoogleServicesFile","getManifestStringAsync","code","owner","addSigningDisabledWarning","chalk","bold","learnMore","ConnectionStatus","setIsOffline","seen","reason","logWarning","Object","keys","process","reduce","prev","hostUUID","currentSession","UserManager","getSessionAsync","isOffline","id","ANONYMOUS_USERNAME","slug","getUnsignedManifestString","getSignedManifestStringAsync","UserSettings","getAnonymousIdentifierAsync","server","serverVersion","require","version","serverDriver","serverOS","os","serverOSVersion","release","user","ensureLoggedInAsync","response","ApiV2","clientForUser","postAsync","args","remoteUsername","getCurrentUsernameAsync","remotePackageName","unsignedManifest","signature"],"sources":["../../src/start/ManifestHandler.ts"],"sourcesContent":["import { ExpoAppManifest, ExpoConfig, ExpoGoConfig, getConfig } from '@expo/config';\nimport { JSONObject } from '@expo/json-file';\nimport chalk from 'chalk';\nimport express from 'express';\nimport http from 'http';\nimport os from 'os';\nimport { parse, URL } from 'url';\n\nimport {\n  Analytics,\n  ANONYMOUS_USERNAME,\n  ApiV2,\n  Config,\n  ConnectionStatus,\n  Doctor,\n  learnMore,\n  ProjectAssets,\n  ProjectSettings,\n  ProjectUtils,\n  resolveEntryPoint,\n  UrlUtils,\n  UserManager,\n  UserSettings,\n  Versions,\n} from '../internal';\n\ninterface HostInfo {\n  host: string;\n  server: 'xdl';\n  serverVersion: string;\n  serverDriver: string | null;\n  serverOS: NodeJS.Platform;\n  serverOSVersion: string;\n}\n\ntype PackagerOptions = ProjectSettings.ProjectSettings;\n\ntype CachedSignedManifest =\n  | {\n      manifestString: null;\n      signedManifest: null;\n    }\n  | {\n      manifestString: string;\n      signedManifest: string;\n    };\n\nconst _cachedSignedManifest: CachedSignedManifest = {\n  manifestString: null,\n  signedManifest: null,\n};\n\nconst blacklistedEnvironmentVariables = new Set([\n  'EXPO_APPLE_PASSWORD',\n  'EXPO_ANDROID_KEY_PASSWORD',\n  'EXPO_ANDROID_KEYSTORE_PASSWORD',\n  'EXPO_IOS_DIST_P12_PASSWORD',\n  'EXPO_IOS_PUSH_P12_PASSWORD',\n  'EXPO_CLI_PASSWORD',\n]);\n\nfunction shouldExposeEnvironmentVariableInManifest(key: string) {\n  if (blacklistedEnvironmentVariables.has(key.toUpperCase())) {\n    return false;\n  }\n  return key.startsWith('REACT_NATIVE_') || key.startsWith('EXPO_');\n}\n\nexport function stripPort(host: string | undefined): string | undefined {\n  if (!host) {\n    return host;\n  }\n  return new URL('/', `http://${host}`).hostname;\n}\n\nexport async function getPackagerOptionsAsync(\n  projectRoot: string\n): Promise<[ProjectSettings.ProjectSettings, PackagerOptions]> {\n  // Get packager opts and then copy into bundleUrlPackagerOpts\n  const projectSettings = await ProjectSettings.readAsync(projectRoot);\n  const bundleUrlPackagerOpts = JSON.parse(JSON.stringify(projectSettings));\n  bundleUrlPackagerOpts.urlType = 'http';\n  if (bundleUrlPackagerOpts.hostType === 'redirect') {\n    bundleUrlPackagerOpts.hostType = 'tunnel';\n  }\n  return [projectSettings, bundleUrlPackagerOpts];\n}\n\nexport async function getBundleUrlAsync({\n  projectRoot,\n  platform,\n  projectSettings,\n  bundleUrlPackagerOpts,\n  mainModuleName,\n  hostname,\n}: {\n  platform: string;\n  hostname?: string;\n  mainModuleName: string;\n  projectRoot: string;\n  projectSettings: PackagerOptions;\n  bundleUrlPackagerOpts: PackagerOptions;\n}): Promise<string> {\n  const queryParams = UrlUtils.constructBundleQueryParams(projectRoot, projectSettings);\n\n  const path = `/${encodeURI(mainModuleName)}.bundle?platform=${encodeURIComponent(\n    platform\n  )}&${queryParams}`;\n\n  return (\n    (await UrlUtils.constructBundleUrlAsync(projectRoot, bundleUrlPackagerOpts, hostname)) + path\n  );\n}\n\nfunction getPlatformFromRequest(headers: http.IncomingHttpHeaders): string {\n  return (headers['exponent-platform'] || 'ios').toString();\n}\n\nexport function getManifestHandler(projectRoot: string) {\n  return async (\n    req: express.Request | http.IncomingMessage,\n    res: express.Response | http.ServerResponse,\n    next: (err?: Error) => void\n  ) => {\n    // Only support `/`, `/manifest`, `/index.exp` for the manifest middleware.\n    if (!req.url) {\n      return next();\n    }\n    if (\n      !['/', '/manifest', '/index.exp'].includes(\n        // Strip the query params\n        parse(req.url).pathname || req.url\n      )\n    ) {\n      return next();\n    }\n\n    try {\n      // We intentionally don't `await`. We want to continue trying even\n      // if there is a potential error in the package.json and don't want to slow\n      // down the request\n      Doctor.validateWithNetworkAsync(projectRoot).catch(error => {\n        ProjectUtils.logError(\n          projectRoot,\n          'expo',\n          `Error: could not load config json at ${projectRoot}: ${error.toString()}`,\n          'doctor-config-json-not-read'\n        );\n      });\n\n      const { manifestString, exp, hostInfo } = await getManifestResponseFromHeadersAsync({\n        projectRoot,\n        headers: req.headers,\n      });\n      const sdkVersion = exp.sdkVersion ?? null;\n\n      // Send the response\n      res.setHeader('Exponent-Server', JSON.stringify(hostInfo));\n      // End the request\n      res.end(manifestString);\n\n      // Log analytics\n      Analytics.logEvent('Serve Manifest', {\n        developerTool: Config.developerTool,\n        sdkVersion,\n      });\n    } catch (e: any) {\n      ProjectUtils.logError(projectRoot, 'expo', e.stack);\n      // 5xx = Server Error HTTP code\n      res.statusCode = 520;\n      res.end(\n        JSON.stringify({\n          error: e.toString(),\n        })\n      );\n    }\n\n    try {\n      const deviceIds = req.headers['expo-dev-client-id'];\n      if (deviceIds) {\n        await ProjectSettings.saveDevicesAsync(projectRoot, deviceIds);\n      }\n    } catch (e: any) {\n      ProjectUtils.logError(projectRoot, 'expo', e.stack);\n    }\n  };\n}\n\nasync function getManifestResponseFromHeadersAsync({\n  projectRoot,\n  headers,\n}: {\n  projectRoot: string;\n  headers: http.IncomingHttpHeaders;\n}): Promise<{ exp: ExpoConfig; manifestString: string; hostInfo: HostInfo }> {\n  // Read from headers\n  const platform = getPlatformFromRequest(headers);\n  const acceptSignature = headers['exponent-accept-signature'];\n  return getManifestResponseAsync({ projectRoot, host: headers.host, platform, acceptSignature });\n}\n\nexport async function getExpoGoConfig({\n  projectRoot,\n  projectSettings,\n  mainModuleName,\n  hostname,\n}: {\n  projectRoot: string;\n  projectSettings: ProjectSettings.ProjectSettings;\n  mainModuleName: string;\n  hostname: string | undefined;\n}): Promise<ExpoGoConfig> {\n  const [debuggerHost, logUrl] = await Promise.all([\n    UrlUtils.constructDebuggerHostAsync(projectRoot, hostname),\n    UrlUtils.constructLogUrlAsync(projectRoot, hostname),\n  ]);\n  return {\n    developer: {\n      tool: Config.developerTool,\n      projectRoot,\n    },\n    packagerOpts: projectSettings,\n    mainModuleName,\n    // Add this string to make Flipper register React Native / Metro as \"running\".\n    // Can be tested by running:\n    // `METRO_SERVER_PORT=19000 open -a flipper.app`\n    // Where 19000 is the port where the Expo project is being hosted.\n    __flipperHack: 'React Native packager is running',\n    debuggerHost,\n    logUrl,\n  };\n}\n\nexport async function getManifestResponseAsync({\n  projectRoot,\n  host,\n  platform,\n  acceptSignature,\n}: {\n  projectRoot: string;\n  platform: string;\n  host?: string;\n  acceptSignature?: string | string[];\n}): Promise<{ exp: ExpoAppManifest; manifestString: string; hostInfo: HostInfo }> {\n  // Read the config\n  const projectConfig = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n  // Opt towards newest functionality when expo isn't installed.\n  if (!projectConfig.exp.sdkVersion) {\n    projectConfig.exp.sdkVersion = 'UNVERSIONED';\n  }\n  // Read from headers\n  const hostname = stripPort(host);\n\n  // Get project entry point and initial module\n  const entryPoint = resolveEntryPoint(projectRoot, platform, projectConfig);\n\n  const mainModuleName = UrlUtils.stripJSExtension(entryPoint);\n  // Gather packager and host info\n  const hostInfo = await createHostInfoAsync();\n  const [projectSettings, bundleUrlPackagerOpts] = await getPackagerOptionsAsync(projectRoot);\n  // Create the manifest and set fields within it\n  const expoGoConfig = await getExpoGoConfig({\n    projectRoot,\n    projectSettings,\n    mainModuleName,\n    hostname,\n  });\n  const hostUri = await UrlUtils.constructHostUriAsync(projectRoot, hostname);\n  const manifest: ExpoAppManifest = {\n    ...(projectConfig.exp as ExpoAppManifest),\n    ...expoGoConfig,\n    hostUri,\n  };\n  // Adding the env variables to the Expo manifest is unsafe.\n  // This feature is deprecated in SDK 41 forward.\n  if (manifest.sdkVersion && Versions.lteSdkVersion(manifest, '40.0.0')) {\n    manifest.env = getManifestEnvironment();\n  }\n\n  // Add URLs to the manifest\n  manifest.bundleUrl = await getBundleUrlAsync({\n    projectRoot,\n    platform,\n    projectSettings,\n    bundleUrlPackagerOpts,\n    mainModuleName,\n    hostname,\n  });\n\n  // Resolve all assets and set them on the manifest as URLs\n  await ProjectAssets.resolveManifestAssets({\n    projectRoot,\n    manifest,\n    async resolver(path) {\n      return manifest.bundleUrl!.match(/^https?:\\/\\/.*?\\//)![0] + 'assets/' + path;\n    },\n  });\n  // The server normally inserts this but if we're offline we'll do it here\n  await ProjectAssets.resolveGoogleServicesFile(projectRoot, manifest);\n\n  // Create the final string\n  let manifestString;\n  try {\n    manifestString = await getManifestStringAsync(manifest, hostInfo.host, acceptSignature);\n  } catch (error: any) {\n    if (error.code === 'UNAUTHORIZED_ERROR' && manifest.owner) {\n      // Don't have permissions for siging, warn and enable offline mode.\n      addSigningDisabledWarning(\n        projectRoot,\n        `This project belongs to ${chalk.bold(\n          `@${manifest.owner}`\n        )} and you have not been granted the appropriate permissions.\\n` +\n          `Please request access from an admin of @${manifest.owner} or change the \"owner\" field to an account you belong to.\\n` +\n          learnMore('https://docs.expo.dev/versions/latest/config/app/#owner')\n      );\n      ConnectionStatus.setIsOffline(true);\n      manifestString = await getManifestStringAsync(manifest, hostInfo.host, acceptSignature);\n    } else if (error.code === 'ENOTFOUND') {\n      // Got a DNS error, i.e. can't access exp.host, warn and enable offline mode.\n      addSigningDisabledWarning(\n        projectRoot,\n        `Could not reach Expo servers, please check if you can access ${\n          error.hostname || 'exp.host'\n        }.`\n      );\n      ConnectionStatus.setIsOffline(true);\n      manifestString = await getManifestStringAsync(manifest, hostInfo.host, acceptSignature);\n    } else {\n      throw error;\n    }\n  }\n\n  return {\n    manifestString,\n    exp: manifest,\n    hostInfo,\n  };\n}\n\nconst addSigningDisabledWarning = (() => {\n  let seen = false;\n  return (projectRoot: string, reason: string) => {\n    if (!seen) {\n      seen = true;\n      ProjectUtils.logWarning(\n        projectRoot,\n        'expo',\n        `${reason}\\nFalling back to offline mode.`,\n        'signing-disabled'\n      );\n    }\n  };\n})();\n\nfunction getManifestEnvironment(): Record<string, any> {\n  return Object.keys(process.env).reduce<Record<string, any>>((prev, key) => {\n    if (shouldExposeEnvironmentVariableInManifest(key)) {\n      prev[key] = process.env[key];\n    }\n    return prev;\n  }, {});\n}\n\nasync function getManifestStringAsync(\n  manifest: ExpoAppManifest,\n  hostUUID: string,\n  acceptSignature?: string | string[]\n): Promise<string> {\n  const currentSession = await UserManager.getSessionAsync();\n  if (!currentSession || ConnectionStatus.isOffline()) {\n    manifest.id = `@${ANONYMOUS_USERNAME}/${manifest.slug}-${hostUUID}`;\n  }\n  if (!acceptSignature) {\n    return JSON.stringify(manifest);\n  } else if (!currentSession || ConnectionStatus.isOffline()) {\n    return getUnsignedManifestString(manifest);\n  } else {\n    return await getSignedManifestStringAsync(manifest, currentSession);\n  }\n}\n\nasync function createHostInfoAsync(): Promise<HostInfo> {\n  const host = await UserSettings.getAnonymousIdentifierAsync();\n\n  return {\n    host,\n    server: 'xdl',\n    serverVersion: require('xdl/package.json').version,\n    serverDriver: Config.developerTool,\n    serverOS: os.platform(),\n    serverOSVersion: os.release(),\n  };\n}\n\nexport async function getSignedManifestStringAsync(\n  manifest: Partial<ExpoAppManifest>,\n  // NOTE: we currently ignore the currentSession that is passed in, see the note below about analytics.\n  currentSession: { sessionSecret?: string; accessToken?: string }\n) {\n  const manifestString = JSON.stringify(manifest);\n  if (_cachedSignedManifest.manifestString === manifestString) {\n    return _cachedSignedManifest.signedManifest;\n  }\n  // WARNING: Removing the following line will regress analytics, see: https://github.com/expo/expo-cli/pull/2357\n  // TODO: make this more obvious from code\n  const user = await UserManager.ensureLoggedInAsync();\n  const { response } = await ApiV2.clientForUser(user).postAsync('manifest/sign', {\n    args: {\n      remoteUsername: manifest.owner ?? (await UserManager.getCurrentUsernameAsync()),\n      remotePackageName: manifest.slug,\n    },\n    manifest: manifest as JSONObject,\n  });\n  _cachedSignedManifest.manifestString = manifestString;\n  _cachedSignedManifest.signedManifest = response;\n  return response;\n}\n\nexport function getUnsignedManifestString(manifest: ExpoConfig) {\n  const unsignedManifest = {\n    manifestString: JSON.stringify(manifest),\n    signature: 'UNSIGNED',\n  };\n  return JSON.stringify(unsignedManifest);\n}\n"],"mappings":"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"}